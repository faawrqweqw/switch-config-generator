{% extends "base.html" %}

{% block title %}首页 - 交换机配置命令生成平台{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- 页面标题 -->
        <div class="text-center mb-4">
            <h1 class="display-6 fw-bold text-primary">
                <i class="fas fa-cogs me-3"></i>
                交换机配置命令生成
            </h1>
            <p class="lead text-muted">
                选择厂商和配置类型，填写参数，一键生成标准化配置命令
            </p>
        </div>

        <!-- 配置表单 -->
        <form method="POST" action="{{ url_for('main.generate_config') }}" id="configForm">
            <!-- 基本选择 -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="fas fa-sliders-h me-2"></i>基本配置
                </h4>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="vendor" class="form-label">
                            <i class="fas fa-building me-1"></i>设备厂商
                        </label>
                        <select class="form-select" id="vendor" name="vendor" required>
                            <option value="">请选择厂商</option>
                            {% for vendor in vendors %}
                            <option value="{{ vendor }}">
                                {% if vendor == 'huawei' %}华为 (Huawei)
                                {% elif vendor == 'h3c' %}新华三 (H3C)
                                {% elif vendor == 'ruijie' %}锐捷 (Ruijie)
                                {% elif vendor == 'cisco' %}思科 (Cisco)
                                {% else %}{{ vendor }}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="config_type" class="form-label">
                            <i class="fas fa-list me-1"></i>配置类型
                        </label>
                        <select class="form-select" id="config_type" name="config_type" required disabled>
                            <option value="">请先选择厂商</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 动态参数表单 -->
            <div class="form-section" id="parametersSection" style="display: none;">
                <h4 class="section-title">
                    <i class="fas fa-edit me-2"></i>配置参数
                </h4>
                <div id="parametersContainer">
                    <!-- 动态生成的参数表单将插入这里 -->
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="form-section">
                <div class="d-grid gap-2 d-md-flex justify-content-md-center btn-group-custom">
                    <button type="submit" class="btn btn-primary btn-lg" id="generateBtn" disabled>
                        <i class="fas fa-magic me-2"></i>
                        生成配置命令
                    </button>
                    <button type="reset" class="btn btn-outline-secondary btn-lg" id="resetBtn">
                        <i class="fas fa-undo me-2"></i>
                        重置表单
                    </button>
                </div>
                
                <!-- 加载状态 -->
                <div class="text-center mt-3 loading" id="loadingIndicator">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">生成中...</span>
                    </div>
                    <p class="mt-2 text-muted">正在生成配置命令，请稍候...</p>
                </div>
            </div>
        </form>

        <!-- 使用说明 -->
        <div class="form-section mt-4">
            <h4 class="section-title">
                <i class="fas fa-info-circle me-2"></i>使用说明
            </h4>
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-check-circle text-success me-2"></i>支持的厂商</h6>
                    <ul class="list-unstyled ms-3">
                        <li><i class="fas fa-dot-circle text-primary me-2"></i>华为 (Huawei)</li>
                        <li><i class="fas fa-dot-circle text-primary me-2"></i>新华三 (H3C)</li>
                        <li><i class="fas fa-dot-circle text-primary me-2"></i>锐捷 (Ruijie)</li>
                        <li><i class="fas fa-dot-circle text-primary me-2"></i>思科 (Cisco)</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-cog text-success me-2"></i>支持的配置</h6>
                    <ul class="list-unstyled ms-3">
                        <li><i class="fas fa-dot-circle text-primary me-2"></i>VLAN管理 <small class="text-muted">(支持批量：10,20,30-40)</small></li>
                        <li><i class="fas fa-dot-circle text-primary me-2"></i>接口配置 <small class="text-muted">(支持范围：Gi0/0/1-4)</small></li>
                        <li><i class="fas fa-dot-circle text-primary me-2"></i>端口聚合 <small class="text-muted">(支持成员端口范围)</small></li>
                        <li><i class="fas fa-dot-circle text-primary me-2"></i>DHCP服务 <small class="text-muted">(支持CIDR和排除地址)</small></li>
                        <li><i class="fas fa-dot-circle text-primary me-2"></i>静态路由 <small class="text-muted">(支持CIDR格式)</small></li>
                        <li><i class="fas fa-dot-circle text-primary me-2"></i>接口IP配置 <small class="text-muted">(支持多接口和CIDR)</small></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const vendorSelect = document.getElementById('vendor');
    const configTypeSelect = document.getElementById('config_type');
    const parametersSection = document.getElementById('parametersSection');
    const parametersContainer = document.getElementById('parametersContainer');
    const generateBtn = document.getElementById('generateBtn');
    const configForm = document.getElementById('configForm');
    const loadingIndicator = document.getElementById('loadingIndicator');

    // 全局变量：当前选择的厂商
    let currentVendor = '';

    // 厂商选择变化事件
    vendorSelect.addEventListener('change', function() {
        const vendor = this.value;
        currentVendor = vendor; // 更新全局变量

        if (vendor) {
            // 获取配置类型
            fetch(`/api/config_types/${vendor}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        configTypeSelect.innerHTML = '<option value="">请选择配置类型</option>';
                        data.config_types.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type.value;
                            option.textContent = type.name;
                            configTypeSelect.appendChild(option);
                        });
                        configTypeSelect.disabled = false;
                    } else {
                        showToast('获取配置类型失败: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('网络错误，请重试', 'error');
                });
        } else {
            configTypeSelect.innerHTML = '<option value="">请先选择厂商</option>';
            configTypeSelect.disabled = true;
            parametersSection.style.display = 'none';
            generateBtn.disabled = true;
        }

        // 重置配置类型和参数
        configTypeSelect.value = '';
        parametersContainer.innerHTML = '';
        parametersSection.style.display = 'none';
        generateBtn.disabled = true;
    });

    // 配置类型选择变化事件
    configTypeSelect.addEventListener('change', function() {
        const vendor = vendorSelect.value;
        const configType = this.value;
        
        if (vendor && configType) {
            // 获取模板参数信息
            fetch(`/api/template_info/${vendor}/${configType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        generateParameterForm(data.template_info);
                        parametersSection.style.display = 'block';
                        generateBtn.disabled = false;
                    } else {
                        showToast('获取模板信息失败: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('网络错误，请重试', 'error');
                });
        } else {
            parametersContainer.innerHTML = '';
            parametersSection.style.display = 'none';
            generateBtn.disabled = true;
        }
    });

    // 生成参数表单（全局函数）
    window.generateParameterForm = function(templateInfo) {
        parametersContainer.innerHTML = '';
        
        if (!templateInfo.parameters) {
            parametersContainer.innerHTML = '<p class="text-muted">此配置类型无需额外参数</p>';
            return;
        }

        const parameters = templateInfo.parameters;

        // 根据order字段对参数进行排序
        const sortedParams = Object.entries(parameters).sort((a, b) => {
            const orderA = a[1].order || 999;
            const orderB = b[1].order || 999;
            return orderA - orderB;
        });

        // 获取当前配置类型
        const configTypeSelect = document.getElementById('config_type');
        const currentConfigType = configTypeSelect ? configTypeSelect.value : '';

        for (const [paramName, paramConfig] of sortedParams) {
            // 华为DHCP服务特殊处理：初始只显示dhcp_type参数
            if (currentVendor === 'huawei' && currentConfigType === 'dhcp_service' && paramName !== 'dhcp_type') {
                // 对于非dhcp_type参数，初始隐藏，由切换函数控制显示
                const dhcpTypeRadio = document.querySelector('input[name="dhcp_type"]:checked');
                const selectedDhcpType = dhcpTypeRadio ? dhcpTypeRadio.value : null;

                if (!selectedDhcpType || !shouldShowHuaweiDhcpParameter(paramName, selectedDhcpType)) {
                    continue;
                }
            }

            const formGroup = document.createElement('div');
            formGroup.className = 'mb-3';
            formGroup.setAttribute('data-param', paramName);

            let inputHtml = '';
            const isRequired = paramConfig.required || false;
            const requiredAttr = isRequired ? 'required' : '';
            const requiredLabel = isRequired ? '<span class="text-danger">*</span>' : '';

            // VLAN一体化配置特殊处理
            if (currentConfigType === 'vlan_complete_config') {
                if (paramName === 'create_vlan') {
                    inputHtml = createVlanCreateToggle(paramName, paramConfig);
                } else if (paramName === 'configure_interface') {
                    inputHtml = createInterfaceConfigToggle(paramName, paramConfig);
                } else if (paramName === 'configure_vlan_ip') {
                    inputHtml = createVlanIpToggle(paramName, paramConfig);
                } else if (paramName === 'port_mode') {
                    // 端口模式下拉框添加切换事件
                    inputHtml = `
                        <label for="${paramName}" class="form-label">${paramConfig.description || paramName} ${requiredLabel}</label>
                        <select class="form-select" id="${paramName}" name="${paramName}" ${requiredAttr} onchange="togglePortModeFields(this.value)">
                            <option value="">请选择</option>
                            ${paramConfig.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                        </select>
                    `;
                }
            }
            // DHCP服务特殊处理
            else if (currentConfigType === 'dhcp_service') {
                if (paramName === 'enable_interface') {
                    inputHtml = createDhcpInterfaceToggle(paramName, paramConfig);
                } else if (paramName === 'dhcp_type' && currentVendor === 'huawei') {
                    inputHtml = createHuaweiDhcpTypeToggle(paramName, paramConfig);
                }
            }
            // 聚合接口特殊处理：开关控制
            else if (currentConfigType === 'port_aggregation') {
                if (paramName === 'configure_load_balance') {
                    inputHtml = createPortAggregationToggle(paramName, paramConfig, '负载均衡配置', '启用后可以配置负载均衡算法');
                } else if (paramName === 'configure_lacp_priority') {
                    inputHtml = createPortAggregationToggle(paramName, paramConfig, 'LACP优先级配置', '启用后可以配置LACP系统和端口优先级');
                } else if (paramName === 'configure_lacp_timeout') {
                    inputHtml = createPortAggregationToggle(paramName, paramConfig, 'LACP超时配置', '启用后可以配置LACP超时模式');
                } else if (paramName === 'configure_advanced') {
                    inputHtml = createPortAggregationToggle(paramName, paramConfig, '高级配置', '启用后可以配置最小活动链路数等高级选项');
                }
            }
            // OSPF特殊处理：开关控制
            else if (currentConfigType === 'ospf_config') {
                if (paramName === 'configure_area_auth') {
                    inputHtml = createOspfToggle(paramName, paramConfig, '区域认证配置', '启用后可以配置OSPF区域认证');
                } else if (paramName === 'configure_interface_auth') {
                    inputHtml = createOspfToggle(paramName, paramConfig, '接口认证配置', '启用后可以配置OSPF接口认证');
                } else if (paramName === 'configure_advanced') {
                    inputHtml = createOspfToggle(paramName, paramConfig, '高级配置', '启用后可以配置Stub区域、NSSA区域、路由聚合等高级选项');
                } else if (paramName === 'configure_interface') {
                    inputHtml = createOspfToggle(paramName, paramConfig, '接口参数配置', '启用后可以配置接口开销、优先级等参数');
                } else if (paramName === 'configure_timers') {
                    inputHtml = createOspfToggle(paramName, paramConfig, '定时器配置', '启用后可以配置Hello间隔和Dead间隔');
                } else if (paramName === 'configure_interface_routing') {
                    inputHtml = createOspfToggle(paramName, paramConfig, '接口路由模式配置', '启用后将物理接口配置为路由模式，支持OSPF配置');
                } else if (paramName === 'configure_redistribute') {
                    inputHtml = createOspfToggle(paramName, paramConfig, '路由引入配置', '启用后可以将其他路由协议的路由引入到OSPF中');
                }
                // 路由引入类型的特殊处理 - 跳过单独显示，将在容器中统一显示
                else if (paramName.startsWith('redistribute_') && paramName !== 'configure_redistribute' && paramName !== 'redistribute_cost' && paramName !== 'redistribute_type' && paramName !== 'redistribute_subnets') {
                    // 跳过单独显示这些字段，它们将在路由类型选择容器中显示
                    continue;
                }
            }
            // STP特殊处理：布尔值参数改为单选框
            else if (currentConfigType === 'stp_config') {
                if (paramName === 'stp_mode') {
                    // STP模式下拉框添加切换事件
                    inputHtml = `
                        <label for="${paramName}" class="form-label">${paramConfig.description || paramName} ${requiredLabel}</label>
                        <select class="form-select" id="${paramName}" name="${paramName}" ${requiredAttr} onchange="updateStpParameters(this.value)">
                            <option value="">请选择</option>
                            ${paramConfig.options.map(option => `<option value="${option}">${option.toUpperCase()}</option>`).join('')}
                        </select>
                    `;
                } else if (paramName === 'global_enable') {
                    // 创建三列布局：全局使能、根桥配置、BPDU保护
                    inputHtml = createStpThreeColumnLayout();
                } else if (paramName === 'root_bridge' || paramName === 'bpdu_protection') {
                    // 这两个参数已经在三列布局中处理，跳过单独渲染
                    continue;
                } else if (paramName === 'configure_timing_params') {
                    inputHtml = createStpTimingToggle(paramName, paramConfig);
                } else if (paramName === 'configure_port_blocking') {
                    inputHtml = createStpPortToggle(paramName, paramConfig);
                } else if (paramName === 'root_primary') {
                    // 只在root_primary时创建根桥配置单选框
                    inputHtml = createStpRadioInput('root_bridge', paramConfig);
                } else if (paramName === 'root_secondary') {
                    // root_secondary跳过，因为已经在root_primary时处理了
                    continue;
                } else if (paramName === 'edge_port') {
                    // 创建保护功能组合单选框（只在edge_port时创建）
                    inputHtml = createStpProtectionRadios(templateInfo.parameters);
                } else if (['edge_port_interface', 'root_protection', 'root_protection_interface', 'loop_protection', 'loop_protection_interface'].includes(paramName)) {
                    // 其他保护功能和接口参数跳过，因为已经在edge_port时处理了
                    continue;
                }
            }

            // 如果没有生成特殊的inputHtml，则根据参数类型生成标准输入控件
            if (!inputHtml && paramConfig.options) {
                // 下拉选择
                inputHtml = `
                    <label for="${paramName}" class="form-label">${paramConfig.description || paramName} ${requiredLabel}</label>
                    <select class="form-select" id="${paramName}" name="${paramName}" ${requiredAttr} ${paramName === 'stp_mode' ? 'onchange="updateStpParameters(this.value)"' : ''}>
                        <option value="">请选择</option>
                        ${paramConfig.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                    </select>
                `;
            } else if (!inputHtml && paramConfig.type === 'list') {
                // 列表输入
                inputHtml = `
                    <label for="${paramName}" class="form-label">${paramConfig.description || paramName} ${requiredLabel}</label>
                    <input type="text" class="form-control" id="${paramName}" name="${paramName}" ${requiredAttr}
                           placeholder="多个值请用逗号分隔，如：值1,值2,值3">
                    <div class="form-help">多个值请用逗号分隔</div>
                `;
            } else if (!inputHtml && paramConfig.type === 'integer') {
                // 数字输入
                const min = paramConfig.range ? paramConfig.range[0] : '';
                const max = paramConfig.range ? paramConfig.range[1] : '';

                // 特殊处理：不同参数需要不同的验证规则
                let stepValidation = '';
                let helpText = paramConfig.range ? `范围: ${paramConfig.range[0]} - ${paramConfig.range[1]}` : '';

                if (paramName === 'bridge_priority') {
                    stepValidation = 'oninput="validateBridgePriority(this)" onblur="validateBridgePriority(this)"';
                    helpText += '，必须是4096的倍数';
                } else if (paramName === 'port_priority') {
                    stepValidation = 'oninput="validatePortPriority(this)" onblur="validatePortPriority(this)"';
                    helpText += '，必须是16的倍数';
                } else if (paramName === 'hello_time') {
                    stepValidation = 'oninput="validateHelloTime(this)" onblur="validateHelloTime(this)"';
                    helpText += '，建议值：2秒';
                } else if (paramName === 'forward_delay') {
                    stepValidation = 'oninput="validateForwardDelay(this)" onblur="validateForwardDelay(this)"';
                    helpText += '，建议值：15秒';
                } else if (paramName === 'max_age') {
                    stepValidation = 'oninput="validateMaxAge(this)" onblur="validateMaxAge(this)"';
                    helpText += '，建议值：20秒';
                } else if (paramName === 'revision_level') {
                    stepValidation = 'oninput="validateRevisionLevel(this)" onblur="validateRevisionLevel(this)"';
                    helpText += '，MSTP域版本号';
                } else if (paramName === 'instance_id') {
                    stepValidation = 'oninput="validateInstanceId(this)" onblur="validateInstanceId(this)"';
                    helpText += '，MSTP实例编号';
                } else if (paramName === 'port_cost') {
                    stepValidation = 'oninput="validatePortCost(this)" onblur="validatePortCost(this)"';
                    helpText += '，端口开销值';
                } else if (currentConfigType === 'stp_config') {
                    // 其他STP相关的整数参数使用通用验证
                    stepValidation = `oninput="validateStpInteger(this, ${min}, ${max})" onblur="validateStpInteger(this, ${min}, ${max})"`;
                }

                inputHtml = `
                    <label for="${paramName}" class="form-label">${paramConfig.description || paramName} ${requiredLabel}</label>
                    <input type="number" class="form-control" id="${paramName}" name="${paramName}" ${requiredAttr}
                           ${min ? `min="${min}"` : ''} ${max ? `max="${max}"` : ''} ${stepValidation}>
                    <div class="form-help">${helpText}</div>
                    <div class="invalid-feedback" id="${paramName}_error"></div>
                `;
            } else if (!inputHtml) {
                // 文本输入
                const maxLength = paramConfig.max_length ? `maxlength="${paramConfig.max_length}"` : '';

                // OSPF接口字段特殊处理
                let additionalValidation = '';
                let helpText = paramConfig.max_length ? `<div class="form-help">最大长度: ${paramConfig.max_length} 个字符</div>` : '';

                if (currentConfigType === 'ospf_config' && (paramName === 'interface_name' || paramName === 'interface_auth_interface')) {
                    additionalValidation = 'oninput="validateOspfInterface(this)" onblur="validateOspfInterface(this)"';
                    helpText = `
                        <div class="form-help">
                            <small class="text-muted">
                                <strong>注意：</strong>OSPF接口配置只能在三层接口上进行。<br>
                                • <strong>VLAN接口</strong>：Vlan-interface1, Vlanif10<br>
                                • <strong>环回接口</strong>：LoopBack0, LoopBack1<br>
                                • <strong>路由接口</strong>：GigabitEthernet1/0/1（需先配置为路由模式）<br>
                                <span class="text-warning">⚠️ 不支持二层物理接口</span>
                            </small>
                        </div>
                        <div class="invalid-feedback" id="${paramName}_error"></div>
                    `;
                }

                inputHtml = `
                    <label for="${paramName}" class="form-label">${paramConfig.description || paramName} ${requiredLabel}</label>
                    <input type="text" class="form-control" id="${paramName}" name="${paramName}" ${requiredAttr} ${maxLength} ${additionalValidation}>
                    ${helpText}
                `;
            }
            
            formGroup.innerHTML = inputHtml;
            parametersContainer.appendChild(formGroup);
        }
        
        // 如果有示例数据，添加示例按钮
        if (templateInfo.example) {
            const exampleBtn = document.createElement('button');
            exampleBtn.type = 'button';
            exampleBtn.className = 'btn btn-outline-info btn-sm mt-2';
            exampleBtn.innerHTML = '<i class="fas fa-lightbulb me-1"></i>填入示例数据';
            exampleBtn.addEventListener('click', function() {
                fillExampleData(templateInfo.example);
            });
            parametersContainer.appendChild(exampleBtn);
        }

        // 如果是STP配置，初始化参数显示（只显示模式选择）
        if (currentConfigType === 'stp_config') {
            // 初始状态只显示STP模式选择，其他参数都隐藏
            updateStpParameters('');
            // 初始隐藏时间参数，因为configure_timing_params开关默认是关闭的
            toggleStpTimingFields(false);
            // 初始隐藏端口参数，因为configure_port_blocking开关默认是关闭的
            toggleStpPortFields(false);
        }

        // 如果是VLAN一体化配置，初始化字段的显示状态
        if (currentConfigType === 'vlan_complete_config') {
            // 初始显示VLAN创建字段，因为create_vlan开关默认是开启的
            toggleVlanCreateFields(true);
            // 初始显示接口配置字段，因为configure_interface开关默认是开启的
            toggleInterfaceConfigFields(true);
            // 初始隐藏VLAN IP相关字段，因为configure_vlan_ip开关默认是关闭的
            toggleVlanIpFields(false);
            // 初始隐藏端口模式相关字段，因为还没有选择端口模式
            togglePortModeFields('');
        }

        // 如果是DHCP配置，初始化接口字段的显示状态
        if (currentConfigType === 'dhcp_service') {
            // 对于非华为厂商，初始隐藏接口字段
            if (currentVendor !== 'huawei') {
                const interfaceField = document.querySelector('[data-param="interface"]');
                if (interfaceField) {
                    interfaceField.style.display = 'none';
                }
            }
        }

        // 如果是聚合接口配置，初始化开关字段的显示状态
        if (currentConfigType === 'port_aggregation') {
            // 初始隐藏所有开关控制的字段，因为开关默认是关闭的
            togglePortAggregationFields('configure_load_balance', false);
            togglePortAggregationFields('configure_lacp_priority', false);
            togglePortAggregationFields('configure_lacp_timeout', false);
            togglePortAggregationFields('configure_advanced', false);
        }

        // 如果是OSPF配置，初始化开关字段的显示状态
        if (currentConfigType === 'ospf_config') {
            // 初始隐藏所有开关控制的字段，因为开关默认是关闭的
            toggleOspfFields('configure_area_auth', false);
            toggleOspfFields('configure_interface_auth', false);
            toggleOspfFields('configure_advanced', false);
            toggleOspfFields('configure_interface', false);
            toggleOspfFields('configure_timers', false);
            toggleOspfFields('configure_interface_routing', false);
            toggleOspfFields('configure_redistribute', false);

            // 创建路由类型选择容器
            createRedistributeTypeContainer();
        }
    }

    // 填入示例数据（全局函数）
    window.fillExampleData = function(example) {
        // 获取当前配置类型
        const configTypeSelect = document.getElementById('config_type');
        const currentConfigType = configTypeSelect ? configTypeSelect.value : '';

        // 先填入所有数据
        for (const [key, value] of Object.entries(example)) {
            // 处理单选框（如根桥配置）
            if (key === 'root_bridge_config') {
                const radioInputs = document.querySelectorAll(`input[name="${key}"][type="radio"]`);
                if (radioInputs.length > 0) {
                    radioInputs.forEach(radio => {
                        radio.checked = (radio.value === value);
                        if (radio.checked) {
                            // 触发根桥配置变化事件
                            if (typeof handleRootBridgeChange === 'function') {
                                handleRootBridgeChange(value);
                            }
                        }
                    });
                }
            } else {
                const input = document.getElementById(key);
                if (input) {
                    if (Array.isArray(value)) {
                        input.value = value.join(', ');
                    } else {
                        input.value = value;
                    }

                    // 如果是STP模式下拉框，触发change事件
                    if (key === 'stp_mode' && currentConfigType === 'stp_config') {
                        input.dispatchEvent(new Event('change'));
                    }
                }
            }
        }

        // 特殊处理聚合接口配置
        if (currentConfigType === 'port_aggregation') {
            // 延迟执行以确保所有数据都已填入
            setTimeout(() => {
                // 恢复开关状态并显示相关字段
                if (example.configure_load_balance) {
                    const loadBalanceToggle = document.getElementById('configure_load_balance');
                    if (loadBalanceToggle) {
                        loadBalanceToggle.checked = true;
                        togglePortAggregationFields('configure_load_balance', true);
                    }
                }

                if (example.configure_lacp_priority) {
                    const lacpPriorityToggle = document.getElementById('configure_lacp_priority');
                    if (lacpPriorityToggle) {
                        lacpPriorityToggle.checked = true;
                        togglePortAggregationFields('configure_lacp_priority', true);
                    }
                }

                if (example.configure_lacp_timeout) {
                    const lacpTimeoutToggle = document.getElementById('configure_lacp_timeout');
                    if (lacpTimeoutToggle) {
                        lacpTimeoutToggle.checked = true;
                        togglePortAggregationFields('configure_lacp_timeout', true);
                    }
                }

                if (example.configure_advanced) {
                    const advancedToggle = document.getElementById('configure_advanced');
                    if (advancedToggle) {
                        advancedToggle.checked = true;
                        togglePortAggregationFields('configure_advanced', true);
                    }
                }
            }, 100);
        }
        // 特殊处理OSPF配置
        else if (currentConfigType === 'ospf_config') {
            // 延迟执行以确保所有数据都已填入
            setTimeout(() => {
                // 恢复开关状态并显示相关字段
                if (example.configure_area_auth) {
                    const areaAuthToggle = document.getElementById('configure_area_auth');
                    if (areaAuthToggle) {
                        areaAuthToggle.checked = true;
                        toggleOspfFields('configure_area_auth', true);
                    }
                }

                if (example.configure_interface_auth) {
                    const interfaceAuthToggle = document.getElementById('configure_interface_auth');
                    if (interfaceAuthToggle) {
                        interfaceAuthToggle.checked = true;
                        toggleOspfFields('configure_interface_auth', true);
                    }
                }

                if (example.configure_advanced) {
                    const advancedToggle = document.getElementById('configure_advanced');
                    if (advancedToggle) {
                        advancedToggle.checked = true;
                        toggleOspfFields('configure_advanced', true);
                    }
                }

                if (example.configure_interface) {
                    const interfaceToggle = document.getElementById('configure_interface');
                    if (interfaceToggle) {
                        interfaceToggle.checked = true;
                        toggleOspfFields('configure_interface', true);
                    }
                }

                if (example.configure_timers) {
                    const timersToggle = document.getElementById('configure_timers');
                    if (timersToggle) {
                        timersToggle.checked = true;
                        toggleOspfFields('configure_timers', true);
                    }
                }

                if (example.configure_interface_routing) {
                    const interfaceRoutingToggle = document.getElementById('configure_interface_routing');
                    if (interfaceRoutingToggle) {
                        interfaceRoutingToggle.checked = true;
                        toggleOspfFields('configure_interface_routing', true);
                    }
                }

                if (example.configure_redistribute) {
                    const redistributeToggle = document.getElementById('configure_redistribute');
                    if (redistributeToggle) {
                        redistributeToggle.checked = true;
                        toggleOspfFields('configure_redistribute', true);

                        // 恢复路由类型选择状态
                        setTimeout(() => {
                            const routeTypes = ['redistribute_static', 'redistribute_direct', 'redistribute_connected', 'redistribute_rip', 'redistribute_bgp', 'redistribute_isis'];
                            routeTypes.forEach(routeType => {
                                if (example[routeType]) {
                                    const checkbox = document.getElementById(routeType);
                                    if (checkbox && checkbox.classList.contains('route-type-checkbox')) {
                                        checkbox.checked = true;
                                        updateRedistributeSelection();
                                    }
                                }
                            });
                        }, 200);
                    }
                }
            }, 100);
        }
        // 特殊处理STP配置
        else if (currentConfigType === 'stp_config') {
            // 延迟执行以确保所有数据都已填入
            setTimeout(() => {
                const stpModeSelect = document.getElementById('stp_mode');
                if (stpModeSelect && stpModeSelect.value) {
                    // 更新STP参数显示
                    updateStpParameters(stpModeSelect.value);

                    // 恢复开关状态
                    const timingToggle = document.getElementById('configure_timing_params');
                    if (timingToggle && example.hello_time) {
                        timingToggle.checked = true;
                        toggleStpTimingFields(true);
                    }

                    const portToggle = document.getElementById('configure_port_blocking');
                    if (portToggle && example.interface) {
                        portToggle.checked = true;
                        toggleStpPortFields(true);
                    }

                    // 恢复保护功能状态
                    if (example.edge_port && example.edge_port_interface) {
                        const edgePortTrue = document.getElementById('edge_port_true');
                        if (edgePortTrue) {
                            edgePortTrue.checked = true;
                            handleEdgePortChange(true);
                        }
                    }

                    if (example.root_protection && example.root_protection_interface) {
                        const rootProtectionTrue = document.getElementById('root_protection_true');
                        if (rootProtectionTrue) {
                            rootProtectionTrue.checked = true;
                            handleProtectionChange('root', true);
                        }
                    }

                    if (example.loop_protection && example.loop_protection_interface) {
                        const loopProtectionTrue = document.getElementById('loop_protection_true');
                        if (loopProtectionTrue) {
                            loopProtectionTrue.checked = true;
                            handleProtectionChange('loop', true);
                        }
                    }
                }
            }, 100);
        }

        showToast('示例数据已填入', 'success');
    }

    // 表单提交事件
    configForm.addEventListener('submit', function(e) {
        // 验证VLAN一体化配置特殊字段
        const configTypeSelect = document.getElementById('config_type');
        if (configTypeSelect && configTypeSelect.value === 'vlan_complete_config') {
            const createVlanCheckbox = document.getElementById('create_vlan');
            const configureInterfaceCheckbox = document.getElementById('configure_interface');
            const vlanIdInput = document.getElementById('vlan_id');
            const interfaceInput = document.getElementById('interface');
            const portModeSelect = document.getElementById('port_mode');
            const pvidInput = document.getElementById('pvid');

            // 如果启用了VLAN创建，VLAN ID必填
            if (createVlanCheckbox && createVlanCheckbox.checked) {
                if (!vlanIdInput || !vlanIdInput.value.trim()) {
                    e.preventDefault();
                    showToast('启用VLAN创建时，VLAN ID为必填项', 'error');
                    if (vlanIdInput) vlanIdInput.focus();
                    return;
                }
            }

            // 如果启用了接口配置，接口名称和端口模式必填
            if (configureInterfaceCheckbox && configureInterfaceCheckbox.checked) {
                if (!interfaceInput || !interfaceInput.value.trim()) {
                    e.preventDefault();
                    showToast('启用接口配置时，接口名称为必填项', 'error');
                    if (interfaceInput) interfaceInput.focus();
                    return;
                }

                if (!portModeSelect || !portModeSelect.value) {
                    e.preventDefault();
                    showToast('启用接口配置时，端口模式为必填项', 'error');
                    if (portModeSelect) portModeSelect.focus();
                    return;
                }

                // access模式下PVID必填
                if (portModeSelect.value === 'access') {
                    if (!pvidInput || !pvidInput.value.trim()) {
                        e.preventDefault();
                        showToast('Access模式下端口PVID为必填项', 'error');
                        if (pvidInput) pvidInput.focus();
                        return;
                    }
                }
            }

            // 至少要启用一个功能
            if ((!createVlanCheckbox || !createVlanCheckbox.checked) &&
                (!configureInterfaceCheckbox || !configureInterfaceCheckbox.checked)) {
                e.preventDefault();
                showToast('请至少启用一个功能：创建VLAN 或 配置接口VLAN', 'error');
                return;
            }
        }

        // 验证STP特殊字段
        if (configTypeSelect && configTypeSelect.value === 'stp_config') {
            let isValid = true;
            const validationFunctions = [
                { id: 'bridge_priority', func: validateBridgePriority },
                { id: 'port_priority', func: validatePortPriority },
                { id: 'hello_time', func: validateHelloTime },
                { id: 'forward_delay', func: validateForwardDelay },
                { id: 'max_age', func: validateMaxAge },
                { id: 'revision_level', func: validateRevisionLevel },
                { id: 'instance_id', func: validateInstanceId },
                { id: 'port_cost', func: validatePortCost }
            ];

            // 验证所有STP数值参数
            validationFunctions.forEach(validation => {
                const input = document.getElementById(validation.id);
                if (input && input.value && input.style.display !== 'none') {
                    if (!validation.func(input)) {
                        isValid = false;
                    }
                }
            });

            // 验证时间参数的逻辑关系
            const helloTimeInput = document.getElementById('hello_time');
            const forwardDelayInput = document.getElementById('forward_delay');
            const maxAgeInput = document.getElementById('max_age');

            if (helloTimeInput && forwardDelayInput && maxAgeInput &&
                helloTimeInput.value && forwardDelayInput.value && maxAgeInput.value) {

                const helloTime = parseInt(helloTimeInput.value);
                const forwardDelay = parseInt(forwardDelayInput.value);
                const maxAge = parseInt(maxAgeInput.value);

                // 检查STP时间参数的标准关系
                if (maxAge < 2 * (helloTime + 1)) {
                    isValid = false;
                    showToast('时间参数关系错误：最大老化时间必须 ≥ 2 × (Hello时间 + 1)', 'error');
                }

                if (forwardDelay < maxAge / 2) {
                    isValid = false;
                    showToast('时间参数关系错误：转发延迟时间建议 ≥ 最大老化时间 / 2', 'warning');
                }
            }

            if (!isValid) {
                e.preventDefault();
                showToast('请修正输入错误后再提交', 'error');
                return;
            }
        }

        // 保存表单数据到sessionStorage
        saveFormData();
        generateBtn.disabled = true;
        loadingIndicator.style.display = 'block';
    });

    // 重置按钮事件
    document.getElementById('resetBtn').addEventListener('click', function() {
        resetForm();
        // 清除保存的表单数据
        sessionStorage.removeItem('lastFormData');
    });

    // 页面加载时检查是否需要恢复表单状态
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('restore') === 'true') {
        restoreFormData();
        // 清除URL参数
        window.history.replaceState({}, document.title, window.location.pathname);
    }
});

// 保存表单数据
function saveFormData() {
    const vendorSelect = document.getElementById('vendor');
    const configTypeSelect = document.getElementById('config_type');
    const parametersContainer = document.getElementById('parametersContainer');

    const formData = {
        vendor: vendorSelect.value,
        configType: configTypeSelect.value,
        parameters: {}
    };

    // 保存所有参数输入
    const paramInputs = parametersContainer.querySelectorAll('input, select');
    paramInputs.forEach(input => {
        if (input.type === 'radio' && input.checked) {
            // 单选框只保存选中的值
            formData.parameters[input.name] = input.value;
        } else if (input.type !== 'radio' && input.value) {
            // 其他类型的输入框保存有值的
            formData.parameters[input.name] = input.value;
        }
    });

    sessionStorage.setItem('lastFormData', JSON.stringify(formData));
}

// 恢复表单数据
function restoreFormData() {
    const vendorSelect = document.getElementById('vendor');
    const configTypeSelect = document.getElementById('config_type');

    const savedData = sessionStorage.getItem('lastFormData');
    if (!savedData) return;

    try {
        const formData = JSON.parse(savedData);

        // 恢复厂商选择
        if (formData.vendor) {
            vendorSelect.value = formData.vendor;
            vendorSelect.dispatchEvent(new Event('change'));

            // 等待配置类型加载完成后恢复配置类型
            setTimeout(() => {
                if (formData.configType) {
                    configTypeSelect.value = formData.configType;
                    configTypeSelect.dispatchEvent(new Event('change'));

                    // 等待参数表单生成完成后恢复参数
                    setTimeout(() => {
                        Object.keys(formData.parameters).forEach(key => {
                            const value = formData.parameters[key];

                            // 处理单选框
                            const radioInputs = document.querySelectorAll(`input[name="${key}"][type="radio"]`);
                            if (radioInputs.length > 0) {
                                radioInputs.forEach(radio => {
                                    radio.checked = (radio.value === value);
                                });
                            } else {
                                // 处理普通输入框和下拉框
                                const input = document.getElementById(key);
                                if (input) {
                                    input.value = value;

                                    // 如果是STP模式下拉框，触发change事件以更新参数显示
                                    if (key === 'stp_mode' && formData.configType === 'stp_config') {
                                        input.dispatchEvent(new Event('change'));
                                    }
                                }
                            }
                        });

                        // 如果是STP配置，确保参数显示正确
                        if (formData.configType === 'stp_config') {
                            const stpModeSelect = document.getElementById('stp_mode');
                            if (stpModeSelect && stpModeSelect.value) {
                                // 延迟一点时间确保所有参数都已恢复
                                setTimeout(() => {
                                    updateStpParameters(stpModeSelect.value);

                                    // 恢复根桥配置状态
                                    const rootBridgeInputs = document.querySelectorAll('input[name="root_bridge_config"]');
                                    rootBridgeInputs.forEach(input => {
                                        if (input.checked) {
                                            handleRootBridgeChange(input.value);
                                        }
                                    });

                                    // 恢复STP保护功能的接口输入框状态
                                    restoreStpProtectionInterfaceState();
                                }, 100);
                            }
                        }

                        showToast('表单状态已恢复，您可以修改参数后重新生成配置', 'info');
                    }, 500);
                }
            }, 500);
        }
    } catch (e) {
        console.error('恢复表单数据失败:', e);
    }
}

// 重置表单
function resetForm() {
    const vendorSelect = document.getElementById('vendor');
    const configTypeSelect = document.getElementById('config_type');
    const parametersContainer = document.getElementById('parametersContainer');
    const parametersSection = document.getElementById('parametersSection');
    const generateBtn = document.getElementById('generateBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');

    vendorSelect.value = '';
    configTypeSelect.innerHTML = '<option value="">请先选择厂商</option>';
    configTypeSelect.disabled = true;
    parametersContainer.innerHTML = '';
    parametersSection.style.display = 'none';
    generateBtn.disabled = true;
    loadingIndicator.style.display = 'none';
}

// STP相关函数（全局）
window.shouldShowStpParameter = function(paramName, stpMode) {
    // 如果没有选择模式，只显示模式选择
    if (!stpMode) {
        return paramName === 'stp_mode';
    }

    // 基本参数，所有模式都显示
    const basicParams = ['stp_mode', 'bridge_priority'];

    // 三列布局参数组（全局使能、根桥配置、BPDU保护）
    const threeColumnParams = ['global_enable', 'root_bridge_config', 'bpdu_protection'];

    // STP保护功能参数，所有模式都显示（不包括bpdu_protection，已在三列布局中）
    const protectionParams = ['edge_port', 'edge_port_interface', 'root_protection', 'root_protection_interface', 'loop_protection', 'loop_protection_interface'];

    // 时间参数开关和相关参数
    const timingParams = ['configure_timing_params', 'hello_time', 'forward_delay', 'max_age'];

    // 端口配置开关和相关参数
    const portParams = ['configure_port_blocking', 'interface', 'port_cost'];

    // MSTP专用参数
    const mstpParams = ['region_name', 'revision_level', 'instance_vlan_mapping', 'instance_id'];

    // 根据模式显示相应参数
    if (basicParams.includes(paramName) || threeColumnParams.includes(paramName) || protectionParams.includes(paramName) || timingParams.includes(paramName) || portParams.includes(paramName)) {
        return true;
    }

    if (stpMode === 'mstp' && mstpParams.includes(paramName)) {
        return true;
    }

    return false;
}

window.createStpRadioInput = function(paramName, paramConfig) {
    const description = paramConfig.description || paramName;

    if (paramName === 'global_enable') {
        return `
            <label class="form-label">${description}</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="${paramName}" id="${paramName}_true" value="true" checked>
                <label class="form-check-label" for="${paramName}_true">启用</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="${paramName}" id="${paramName}_false" value="false">
                <label class="form-check-label" for="${paramName}_false">禁用</label>
            </div>
        `;
    } else if (paramName === 'bpdu_protection') {
        return `
            <label class="form-label">全局使能BPDU保护</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="${paramName}" id="${paramName}_true" value="true">
                <label class="form-check-label" for="${paramName}_true">启用</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="${paramName}" id="${paramName}_false" value="false" checked>
                <label class="form-check-label" for="${paramName}_false">禁用</label>
            </div>
        `;
    } else if (paramName === 'root_bridge') {
        return `
            <label class="form-label">根桥配置</label>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="root_bridge_config" id="root_none" value="none" checked onchange="handleRootBridgeChange(this.value)">
                <label class="form-check-label" for="root_none">不配置根桥</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="root_bridge_config" id="root_primary" value="primary" onchange="handleRootBridgeChange(this.value)">
                <label class="form-check-label" for="root_primary">配置为根桥</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="root_bridge_config" id="root_secondary" value="secondary" onchange="handleRootBridgeChange(this.value)">
                <label class="form-check-label" for="root_secondary">配置为备份根桥</label>
            </div>
        `;
    }

    return '';
}

// 创建STP时间参数配置开关（全局）
window.createStpTimingToggle = function(paramName, paramConfig) {
    const description = paramConfig.description || paramName;

    return `
        <label class="form-label">${description}</label>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="${paramName}" name="${paramName}" value="true" onchange="toggleStpTimingFields(this.checked)">
            <label class="form-check-label" for="${paramName}">配置参数</label>
        </div>
        <div class="form-help">
            <small class="text-muted">启用后可以配置影响RSTP/MSTP拓扑收敛的时间参数</small>
        </div>
    `;
}

// 创建STP三列布局（全局使能、根桥配置、BPDU保护）（全局）
window.createStpThreeColumnLayout = function() {
    return `
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">全局使能生成树协议</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="global_enable" id="global_enable_true" value="true" checked>
                    <label class="form-check-label" for="global_enable_true">启用</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="global_enable" id="global_enable_false" value="false">
                    <label class="form-check-label" for="global_enable_false">禁用</label>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label">根桥配置</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="root_bridge_config" id="root_none" value="none" checked onchange="handleRootBridgeChange(this.value)">
                    <label class="form-check-label" for="root_none">不配置根桥</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="root_bridge_config" id="root_primary" value="primary" onchange="handleRootBridgeChange(this.value)">
                    <label class="form-check-label" for="root_primary">配置为根桥</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="root_bridge_config" id="root_secondary" value="secondary" onchange="handleRootBridgeChange(this.value)">
                    <label class="form-check-label" for="root_secondary">配置为备份根桥</label>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label">全局使能BPDU保护</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="bpdu_protection" id="bpdu_protection_true" value="true">
                    <label class="form-check-label" for="bpdu_protection_true">启用</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="bpdu_protection" id="bpdu_protection_false" value="false" checked>
                    <label class="form-check-label" for="bpdu_protection_false">禁用</label>
                </div>
            </div>
        </div>
    `;
}

// 创建STP端口配置开关（全局）
window.createStpPortToggle = function(paramName, paramConfig) {
    const description = paramConfig.description || paramName;

    return `
        <label class="form-label">${description}</label>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="${paramName}" name="${paramName}" value="true" onchange="toggleStpPortFields(this.checked)">
            <label class="form-check-label" for="${paramName}">配置参数</label>
        </div>
        <div class="form-help">
            <small class="text-muted">启用后可以配置端口阻塞相关参数</small>
        </div>
    `;
}

// 创建VLAN创建开关（全局）
window.createVlanCreateToggle = function(paramName, paramConfig) {
    const description = paramConfig.description || paramName;

    return `
        <label class="form-label">${description}</label>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="${paramName}" name="${paramName}" value="true" checked onchange="toggleVlanCreateFields(this.checked)">
            <label class="form-check-label" for="${paramName}">创建VLAN</label>
        </div>
        <div class="form-help">
            <small class="text-muted">启用后将创建指定的VLAN</small>
        </div>
    `;
}

// 创建接口配置开关（全局）
window.createInterfaceConfigToggle = function(paramName, paramConfig) {
    const description = paramConfig.description || paramName;

    return `
        <label class="form-label">${description}</label>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="${paramName}" name="${paramName}" value="true" checked onchange="toggleInterfaceConfigFields(this.checked)">
            <label class="form-check-label" for="${paramName}">配置接口VLAN</label>
        </div>
        <div class="form-help">
            <small class="text-muted">启用后将在指定接口上配置VLAN</small>
        </div>
    `;
}

// 创建VLAN IP配置切换开关（全局）
window.createVlanIpToggle = function(paramName, paramConfig) {
    const description = paramConfig.description || paramName;

    return `
        <label class="form-label">${description}</label>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="${paramName}" name="${paramName}" value="true" onchange="toggleVlanIpFields(this.checked)">
            <label class="form-check-label" for="${paramName}">启用VLAN接口IP配置</label>
        </div>
        <div class="form-help">
            <small class="text-muted">启用后可以为VLAN配置网关IP地址</small>
        </div>
    `;
}

// 切换VLAN创建相关字段的显示/隐藏（全局）
window.toggleVlanCreateFields = function(enabled) {
    const vlanCreateFields = ['vlan_id', 'vlan_name'];

    vlanCreateFields.forEach(fieldName => {
        const fieldGroup = document.querySelector(`[data-param="${fieldName}"]`);
        if (fieldGroup) {
            fieldGroup.style.display = enabled ? 'block' : 'none';

            // 如果禁用，清空字段值
            if (!enabled) {
                const input = document.getElementById(fieldName);
                if (input) {
                    input.value = '';
                }
            }
        }
    });
}

// 切换接口配置相关字段的显示/隐藏（全局）
window.toggleInterfaceConfigFields = function(enabled) {
    const interfaceConfigFields = ['interface', 'port_mode', 'pvid', 'allowed_vlans', 'native_vlan'];

    interfaceConfigFields.forEach(fieldName => {
        const fieldGroup = document.querySelector(`[data-param="${fieldName}"]`);
        if (fieldGroup) {
            fieldGroup.style.display = enabled ? 'block' : 'none';

            // 如果禁用，清空字段值
            if (!enabled) {
                const input = document.getElementById(fieldName);
                if (input) {
                    input.value = '';
                }
            }
        }
    });

    // 如果禁用接口配置，也要重置端口模式相关的显示状态
    if (!enabled) {
        togglePortModeFields('');
    }
}

// 切换VLAN IP相关字段的显示/隐藏（全局）
window.toggleVlanIpFields = function(enabled) {
    const vlanIpFields = ['vlan_ip_address', 'vlan_ip_description'];

    vlanIpFields.forEach(fieldName => {
        const fieldGroup = document.querySelector(`[data-param="${fieldName}"]`);
        if (fieldGroup) {
            fieldGroup.style.display = enabled ? 'block' : 'none';

            // 如果禁用，清空字段值
            if (!enabled) {
                const input = document.getElementById(fieldName);
                if (input) {
                    input.value = '';
                }
            }
        }
    });
}

// 创建DHCP接口配置切换开关（全局）
window.createDhcpInterfaceToggle = function(paramName, paramConfig) {
    const description = paramConfig.description || paramName;

    return `
        <label class="form-label">${description}</label>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="${paramName}" name="${paramName}" value="true" onchange="toggleDhcpInterfaceFields(this.checked)">
            <label class="form-check-label" for="${paramName}">在指定接口上启用DHCP服务</label>
        </div>
        <div class="form-help">
            <small class="text-muted">启用后DHCP服务将绑定到指定的接口上</small>
        </div>
    `;
}

// 切换DHCP接口相关字段的显示/隐藏（全局）
window.toggleDhcpInterfaceFields = function(enabled) {
    const interfaceField = document.querySelector('[data-param="interface"]');

    if (interfaceField) {
        interfaceField.style.display = enabled ? 'block' : 'none';

        // 如果禁用，清空字段值
        if (!enabled) {
            const input = document.getElementById('interface');
            if (input) {
                input.value = '';
            }
        }
    }
}

// 切换端口模式相关字段的显示/隐藏（全局）
window.togglePortModeFields = function(portMode) {
    console.log('切换端口模式到:', portMode);

    // PVID字段 - 两种模式都可能需要，但access模式必填，trunk模式可选
    const pvidField = document.querySelector('[data-param="pvid"]');
    if (pvidField) {
        if (portMode === 'access' || portMode === 'trunk') {
            pvidField.style.display = 'block';

            // 更新必填状态
            const pvidInput = document.getElementById('pvid');
            if (pvidInput) {
                if (portMode === 'access') {
                    pvidInput.required = true;
                    // 更新标签显示必填标记
                    const label = pvidField.querySelector('label');
                    if (label && !label.innerHTML.includes('text-danger')) {
                        label.innerHTML = label.innerHTML.replace('端口PVID', '端口PVID <span class="text-danger">*</span>');
                    }
                } else {
                    pvidInput.required = false;
                    // 移除必填标记
                    const label = pvidField.querySelector('label');
                    if (label) {
                        label.innerHTML = label.innerHTML.replace(' <span class="text-danger">*</span>', '');
                    }
                }
            }
        } else {
            pvidField.style.display = 'none';
            const pvidInput = document.getElementById('pvid');
            if (pvidInput) {
                pvidInput.value = '';
                pvidInput.required = false;
            }
        }
    }

    // trunk模式专用字段
    const trunkFields = ['allowed_vlans', 'native_vlan'];
    trunkFields.forEach(fieldName => {
        const fieldGroup = document.querySelector(`[data-param="${fieldName}"]`);
        if (fieldGroup) {
            fieldGroup.style.display = (portMode === 'trunk') ? 'block' : 'none';

            // 如果隐藏，清空字段值
            if (portMode !== 'trunk') {
                const input = document.getElementById(fieldName);
                if (input) input.value = '';
            }
        }
    });
}

// 切换STP时间参数相关字段的显示/隐藏（全局）
window.toggleStpTimingFields = function(enabled) {
    const timingFields = ['hello_time', 'forward_delay', 'max_age'];

    timingFields.forEach(fieldName => {
        const fieldGroup = document.querySelector(`[data-param="${fieldName}"]`);
        if (fieldGroup) {
            fieldGroup.style.display = enabled ? 'block' : 'none';

            // 如果禁用，清空字段值
            if (!enabled) {
                const input = document.getElementById(fieldName);
                if (input) {
                    input.value = '';
                }
            }
        }
    });
}

// 切换STP端口配置相关字段的显示/隐藏（全局）
window.toggleStpPortFields = function(enabled) {
    const portFields = ['interface', 'port_cost'];

    portFields.forEach(fieldName => {
        const fieldGroup = document.querySelector(`[data-param="${fieldName}"]`);
        if (fieldGroup) {
            fieldGroup.style.display = enabled ? 'block' : 'none';

            // 如果禁用，清空字段值
            if (!enabled) {
                const input = document.getElementById(fieldName);
                if (input) {
                    input.value = '';
                }
            }
        }
    });
}

// 创建聚合接口配置开关（全局）
window.createPortAggregationToggle = function(paramName, paramConfig, displayName, helpText) {
    return `
        <label class="form-label">${displayName}</label>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="${paramName}" name="${paramName}" value="true" onchange="togglePortAggregationFields('${paramName}', this.checked)">
            <label class="form-check-label" for="${paramName}">启用配置</label>
        </div>
        <div class="form-help">
            <small class="text-muted">${helpText}</small>
        </div>
    `;
}

// 切换聚合接口配置相关字段的显示/隐藏（全局）
window.togglePortAggregationFields = function(toggleType, enabled) {
    let fieldsToToggle = [];

    switch(toggleType) {
        case 'configure_load_balance':
            fieldsToToggle = ['load_balance_mode', 'enhanced_load_balance'];
            break;
        case 'configure_lacp_priority':
            fieldsToToggle = ['lacp_system_priority', 'lacp_port_priority'];
            break;
        case 'configure_lacp_timeout':
            fieldsToToggle = ['lacp_timeout', 'lacp_rate'];
            break;
        case 'configure_advanced':
            fieldsToToggle = ['min_active_links', 'local_preference'];
            break;
    }

    fieldsToToggle.forEach(fieldName => {
        const fieldGroup = document.querySelector(`[data-param="${fieldName}"]`);
        if (fieldGroup) {
            fieldGroup.style.display = enabled ? 'block' : 'none';

            // 如果禁用，清空字段值
            if (!enabled) {
                const input = document.getElementById(fieldName);
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                }
            }
        }
    });
}

// 创建OSPF配置开关（全局）
window.createOspfToggle = function(paramName, paramConfig, displayName, helpText) {
    return `
        <label class="form-label">${displayName}</label>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="${paramName}" name="${paramName}" value="true" onchange="toggleOspfFields('${paramName}', this.checked)">
            <label class="form-check-label" for="${paramName}">启用配置</label>
        </div>
        <div class="form-help">
            <small class="text-muted">${helpText}</small>
        </div>
    `;
}

// 创建路由引入类型卡片（全局）
window.createRedistributeTypeCard = function(paramName, paramConfig) {
    // 路由类型图标和描述映射
    const routeTypeInfo = {
        'redistribute_static': {
            icon: '🔧',
            title: '静态路由',
            description: '手动配置的静态路由表项',
            color: 'primary'
        },
        'redistribute_direct': {
            icon: '🔗',
            title: '直连路由',
            description: '接口直接连接的网络路由',
            color: 'success'
        },
        'redistribute_connected': {
            icon: '🔗',
            title: '直连路由',
            description: '接口直接连接的网络路由',
            color: 'success'
        },
        'redistribute_rip': {
            icon: '📡',
            title: 'RIP路由',
            description: 'RIP协议学习到的路由信息',
            color: 'info'
        },
        'redistribute_bgp': {
            icon: '🌐',
            title: 'BGP路由',
            description: 'BGP协议学习到的路由信息',
            color: 'warning'
        },
        'redistribute_isis': {
            icon: '🛰️',
            title: 'ISIS路由',
            description: 'ISIS协议学习到的路由信息',
            color: 'secondary'
        }
    };

    const info = routeTypeInfo[paramName] || {
        icon: '📋',
        title: paramConfig.description || paramName,
        description: '其他路由协议',
        color: 'light'
    };

    return `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100 route-type-card" data-param="${paramName}">
                <div class="card-body p-3">
                    <div class="form-check">
                        <input class="form-check-input route-type-checkbox" type="checkbox" id="${paramName}" name="${paramName}" value="true" onchange="updateRedistributeSelection()">
                        <label class="form-check-label w-100" for="${paramName}">
                            <div class="d-flex align-items-center mb-2">
                                <span class="route-icon me-2" style="font-size: 1.5rem;">${info.icon}</span>
                                <strong class="text-${info.color}">${info.title}</strong>
                            </div>
                            <small class="text-muted">${info.description}</small>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// 显示路由类型选择区域（全局）
window.showRedistributeTypeSelection = function() {
    // 查找所有路由类型字段并组织成卡片布局
    const routeTypeFields = ['redistribute_static', 'redistribute_direct', 'redistribute_connected', 'redistribute_rip', 'redistribute_bgp', 'redistribute_isis'];

    // 创建路由类型选择容器
    let routeTypeContainer = document.getElementById('redistribute-type-container');
    if (!routeTypeContainer) {
        // 找到第一个路由类型字段的位置
        const firstRouteField = document.querySelector('[data-param="redistribute_static"]')?.closest('.form-group');
        if (firstRouteField) {
            routeTypeContainer = document.createElement('div');
            routeTypeContainer.id = 'redistribute-type-container';
            routeTypeContainer.className = 'form-group';
            routeTypeContainer.innerHTML = `
                <label class="form-label">选择要引入的路由类型</label>
                <div class="row" id="redistribute-cards-container">
                </div>
            `;
            firstRouteField.parentNode.insertBefore(routeTypeContainer, firstRouteField);
        }
    }

    // 隐藏原始的路由类型字段
    routeTypeFields.forEach(fieldName => {
        const fieldGroup = document.querySelector(`[data-param="${fieldName}"]`)?.closest('.form-group');
        if (fieldGroup) {
            fieldGroup.style.display = 'none';
        }
    });

    // 显示容器
    if (routeTypeContainer) {
        routeTypeContainer.style.display = 'block';
    }
}

// 隐藏路由类型选择区域（全局）
window.hideRedistributeTypeSelection = function() {
    const routeTypeContainer = document.getElementById('redistribute-type-container');
    if (routeTypeContainer) {
        routeTypeContainer.style.display = 'none';
    }

    // 清空所有路由类型选择
    const routeTypeCheckboxes = document.querySelectorAll('.route-type-checkbox');
    routeTypeCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
        // 同时清空对应的隐藏字段
        const hiddenField = document.getElementById(checkbox.id + '_hidden');
        if (hiddenField) {
            hiddenField.value = '';
        }
    });
}

// 更新路由引入选择状态（全局）
window.updateRedistributeSelection = function() {
    // 同步卡片选择状态到隐藏字段
    const routeTypeCheckboxes = document.querySelectorAll('.route-type-checkbox');
    routeTypeCheckboxes.forEach(checkbox => {
        const hiddenField = document.getElementById(checkbox.id + '_hidden');
        if (hiddenField) {
            hiddenField.value = checkbox.checked ? 'true' : '';
        }
    });

    // 更新卡片样式
    updateRedistributeCardStyles();
}

// 更新路由引入卡片样式（全局）
window.updateRedistributeCardStyles = function() {
    const cards = document.querySelectorAll('.route-type-card');
    cards.forEach(card => {
        const checkbox = card.querySelector('.route-type-checkbox');
        if (checkbox && checkbox.checked) {
            card.classList.add('border-primary', 'bg-light');
            card.style.transform = 'scale(1.02)';
            card.style.transition = 'all 0.2s ease';
        } else {
            card.classList.remove('border-primary', 'bg-light');
            card.style.transform = 'scale(1)';
        }
    });
}

// 创建路由类型选择容器（全局）
window.createRedistributeTypeContainer = function() {
    // 查找路由引入开销字段的位置，在它之前插入路由类型选择容器
    const costField = document.querySelector('[data-param="redistribute_cost"]');
    if (costField) {
        const routeTypeContainer = document.createElement('div');
        routeTypeContainer.id = 'redistribute-type-container';
        routeTypeContainer.className = 'form-group';
        routeTypeContainer.style.display = 'none'; // 初始隐藏

        // 获取当前厂商信息
        const vendorSelect = document.getElementById('vendor');
        const currentVendor = vendorSelect ? vendorSelect.value : '';

        // 根据厂商显示不同的路由类型
        let routeTypeCards = '';
        if (currentVendor === 'huawei' || currentVendor === 'h3c') {
            routeTypeCards = `
                ${createRedistributeTypeCard('redistribute_static', {description: '引入静态路由'})}
                ${createRedistributeTypeCard('redistribute_direct', {description: '引入直连路由'})}
                ${createRedistributeTypeCard('redistribute_rip', {description: '引入RIP路由'})}
                ${createRedistributeTypeCard('redistribute_bgp', {description: '引入BGP路由'})}
                ${createRedistributeTypeCard('redistribute_isis', {description: '引入ISIS路由'})}
            `;
        } else {
            routeTypeCards = `
                ${createRedistributeTypeCard('redistribute_static', {description: '引入静态路由'})}
                ${createRedistributeTypeCard('redistribute_connected', {description: '引入直连路由'})}
                ${createRedistributeTypeCard('redistribute_rip', {description: '引入RIP路由'})}
                ${createRedistributeTypeCard('redistribute_bgp', {description: '引入BGP路由'})}
                ${createRedistributeTypeCard('redistribute_isis', {description: '引入ISIS路由'})}
            `;
        }

        routeTypeContainer.innerHTML = `
            <label class="form-label">选择要引入的路由类型</label>
            <div class="row" id="redistribute-cards-container">
                ${routeTypeCards}
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    选择需要引入到OSPF中的路由协议类型。可以同时选择多种类型。
                </small>
            </div>
        `;

        // 在开销字段之前插入容器
        costField.parentNode.insertBefore(routeTypeContainer, costField);

        // 创建隐藏的原始字段用于表单提交
        createHiddenRedistributeFields(costField.parentNode);
    }
}

// 创建隐藏的路由引入字段（全局）
window.createHiddenRedistributeFields = function(container) {
    const routeTypes = ['redistribute_static', 'redistribute_direct', 'redistribute_connected', 'redistribute_rip', 'redistribute_bgp', 'redistribute_isis'];

    routeTypes.forEach(fieldName => {
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.id = fieldName + '_hidden'; // 使用不同的ID避免冲突
        hiddenField.name = fieldName;
        hiddenField.value = '';
        container.appendChild(hiddenField);
    });
}

// 切换OSPF配置相关字段的显示/隐藏（全局）
window.toggleOspfFields = function(toggleType, enabled) {
    let fieldsToToggle = [];

    switch(toggleType) {
        case 'configure_area_auth':
            fieldsToToggle = ['area_auth_type', 'area_auth_area', 'area_auth_password'];
            break;
        case 'configure_interface_auth':
            fieldsToToggle = ['interface_auth_interface', 'interface_auth_type', 'interface_auth_password'];
            break;
        case 'configure_advanced':
            fieldsToToggle = ['stub_area', 'nssa_area', 'area_range'];
            break;
        case 'configure_interface':
            fieldsToToggle = ['interface_name', 'interface_cost', 'interface_priority'];
            break;
        case 'configure_timers':
            fieldsToToggle = ['hello_interval', 'dead_interval'];
            break;
        case 'configure_interface_routing':
            // 这个开关不控制任何字段的显示，只是一个配置选项
            fieldsToToggle = [];
            break;
        case 'configure_redistribute':
            fieldsToToggle = ['redistribute_static', 'redistribute_direct', 'redistribute_connected', 'redistribute_rip', 'redistribute_bgp', 'redistribute_isis', 'redistribute_cost', 'redistribute_type', 'redistribute_subnets'];
            // 特殊处理：显示路由类型选择区域
            if (enabled) {
                showRedistributeTypeSelection();
            } else {
                hideRedistributeTypeSelection();
            }
            break;
    }

    fieldsToToggle.forEach(fieldName => {
        const fieldGroup = document.querySelector(`[data-param="${fieldName}"]`);
        if (fieldGroup) {
            fieldGroup.style.display = enabled ? 'block' : 'none';

            // 如果禁用，清空字段值
            if (!enabled) {
                const input = document.getElementById(fieldName);
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                }
            }
        }
    });
}

// 创建华为DHCP类型切换开关（全局）
window.createHuaweiDhcpTypeToggle = function(paramName, paramConfig) {
    const description = paramConfig.description || paramName;

    return `
        <label class="form-label">${description}</label>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="${paramName}" id="${paramName}_global" value="global" checked onchange="toggleHuaweiDhcpFields(this.value)">
            <label class="form-check-label" for="${paramName}_global">全局地址池模式</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="${paramName}" id="${paramName}_interface" value="interface" onchange="toggleHuaweiDhcpFields(this.value)">
            <label class="form-check-label" for="${paramName}_interface">接口地址池模式</label>
        </div>
        <div class="form-help">
            <small class="text-muted">
                <strong>全局地址池:</strong> 创建全局DHCP池，可在多个接口上使用<br>
                <strong>接口地址池:</strong> 在指定接口上直接配置DHCP服务
            </small>
        </div>
    `;
}

// 判断华为DHCP参数是否应该显示（全局）
window.shouldShowHuaweiDhcpParameter = function(paramName, dhcpType) {
    // dhcp_type参数始终显示
    if (paramName === 'dhcp_type') {
        return true;
    }

    // 通用参数（两种模式都显示）
    const commonParams = ['gateway', 'dns_servers', 'excluded_addresses', 'lease_time'];
    if (commonParams.includes(paramName)) {
        return true;
    }

    // 全局地址池模式专用参数
    const globalParams = ['pool_name', 'network', 'mask', 'vlanif'];
    if (dhcpType === 'global' && globalParams.includes(paramName)) {
        return true;
    }

    // 接口地址池模式专用参数
    const interfaceParams = ['vlanif', 'interface_ip', 'interface_description'];
    if (dhcpType === 'interface' && interfaceParams.includes(paramName)) {
        return true;
    }

    return false;
}

// 切换华为DHCP模式相关字段的显示/隐藏（全局）
window.toggleHuaweiDhcpFields = function(dhcpType) {
    console.log('切换华为DHCP类型到:', dhcpType);

    // 直接动态显示/隐藏参数，不重新渲染整个表单
    const parametersContainer = document.getElementById('parametersContainer');
    const allParams = parametersContainer.querySelectorAll('[data-param]');

    allParams.forEach(paramGroup => {
        const paramName = paramGroup.getAttribute('data-param');

        if (paramName === 'dhcp_type') {
            // dhcp_type参数始终显示
            paramGroup.style.display = 'block';
        } else {
            // 根据DHCP类型决定是否显示其他参数
            const shouldShow = shouldShowHuaweiDhcpParameter(paramName, dhcpType);
            paramGroup.style.display = shouldShow ? 'block' : 'none';

            // 如果隐藏参数，清空其值
            if (!shouldShow) {
                const input = paramGroup.querySelector('input, select');
                if (input) input.value = '';
            }

            console.log(`参数 ${paramName}: ${shouldShow ? '显示' : '隐藏'} (${dhcpType}模式)`);
        }
    });
}

// 创建STP保护功能单选框组合（全局）
window.createStpProtectionRadios = function(parameters) {
    return `
        <label class="form-label">STP保护功能配置</label>
        <div class="row">
            <div class="col-md-4">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="edge_port" id="edge_port_true" value="true" onchange="handleEdgePortChange(this.checked)">
                    <label class="form-check-label" for="edge_port_true">启用边缘端口</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="edge_port" id="edge_port_false" value="false" checked onchange="handleEdgePortChange(false)">
                    <label class="form-check-label" for="edge_port_false">禁用边缘端口</label>
                </div>
                <!-- 边缘端口接口输入框 -->
                <div id="edge_port_interface_group" style="display: none; margin-top: 10px;">
                    <label for="edge_port_interface" class="form-label">边缘端口接口</label>
                    <input type="text" class="form-control" id="edge_port_interface" name="edge_port_interface" placeholder="如：GigabitEthernet1/0/1-4" oninput="validatePortConflicts('edge_port')">
                    <div class="form-help">
                        <small class="text-muted">支持接口范围配置</small>
                    </div>
                    <div class="invalid-feedback" id="edge_port_interface_error"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="root_protection" id="root_protection_true" value="true" onchange="handleProtectionChange('root', this.checked)">
                    <label class="form-check-label" for="root_protection_true">启用根保护</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="root_protection" id="root_protection_false" value="false" checked onchange="handleProtectionChange('root', false)">
                    <label class="form-check-label" for="root_protection_false">禁用根保护</label>
                </div>
                <!-- 根保护接口输入框 -->
                <div id="root_protection_interface_group" style="display: none; margin-top: 10px;">
                    <label for="root_protection_interface" class="form-label">根保护接口</label>
                    <input type="text" class="form-control" id="root_protection_interface" name="root_protection_interface" placeholder="如：GigabitEthernet1/0/5-8" oninput="validatePortConflicts('root_protection')">
                    <div class="form-help">
                        <small class="text-muted">支持接口范围配置</small>
                    </div>
                    <div class="invalid-feedback" id="root_protection_interface_error"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="loop_protection" id="loop_protection_true" value="true" onchange="handleProtectionChange('loop', this.checked)">
                    <label class="form-check-label" for="loop_protection_true">启用环路保护</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="loop_protection" id="loop_protection_false" value="false" checked onchange="handleProtectionChange('loop', false)">
                    <label class="form-check-label" for="loop_protection_false">禁用环路保护</label>
                </div>
                <!-- 环路保护接口输入框 -->
                <div id="loop_protection_interface_group" style="display: none; margin-top: 10px;">
                    <label for="loop_protection_interface" class="form-label">环路保护接口</label>
                    <input type="text" class="form-control" id="loop_protection_interface" name="loop_protection_interface" placeholder="如：GigabitEthernet1/0/9-12" oninput="validatePortConflicts('loop_protection')">
                    <div class="form-help">
                        <small class="text-muted">支持接口范围配置</small>
                    </div>
                    <div class="invalid-feedback" id="loop_protection_interface_error"></div>
                </div>
            </div>
        </div>
        <div class="form-help mt-3">
            <div class="alert alert-info" style="padding: 10px; font-size: 0.875rem;">
                <strong>端口互斥规则：</strong><br>
                • 同一端口不能同时配置边缘端口和环路保护<br>
                • 同一端口不能同时配置根保护和环路保护<br>
                • 不同端口可以分别配置不同的保护功能
            </div>
            <small class="text-muted">
                <strong>边缘端口:</strong> 连接终端设备的端口，可快速进入转发状态<br>
                <strong>根保护:</strong> 防止指定端口意外成为根端口<br>
                <strong>环路保护:</strong> 防止单向链路故障导致的环路<br>
                <em>注：BPDU保护已移至上方"全局使能BPDU保护"配置</em>
            </small>
        </div>
    `;
}

// 处理边缘端口配置变化（全局）
window.handleEdgePortChange = function(enabled) {
    const interfaceGroup = document.getElementById('edge_port_interface_group');
    const interfaceInput = document.getElementById('edge_port_interface');

    if (interfaceGroup && interfaceInput) {
        if (enabled) {
            interfaceGroup.style.display = 'block';
        } else {
            interfaceGroup.style.display = 'none';
            interfaceInput.value = '';
        }
    }
}

// 处理根保护/环路保护配置变化（全局）
window.handleProtectionChange = function(type, enabled) {
    const rootProtectionGroup = document.getElementById('root_protection_interface_group');
    const loopProtectionGroup = document.getElementById('loop_protection_interface_group');
    const rootProtectionInput = document.getElementById('root_protection_interface');
    const loopProtectionInput = document.getElementById('loop_protection_interface');

    if (type === 'root') {
        if (enabled) {
            // 启用根保护时，显示根保护接口输入框
            if (rootProtectionGroup) {
                rootProtectionGroup.style.display = 'block';
            }
        } else {
            // 禁用根保护时，隐藏根保护接口输入框并清空值
            if (rootProtectionGroup) {
                rootProtectionGroup.style.display = 'none';
            }
            if (rootProtectionInput) {
                rootProtectionInput.value = '';
            }
        }
    } else if (type === 'loop') {
        if (enabled) {
            // 启用环路保护时，显示环路保护接口输入框
            if (loopProtectionGroup) {
                loopProtectionGroup.style.display = 'block';
            }
        } else {
            // 禁用环路保护时，隐藏环路保护接口输入框并清空值
            if (loopProtectionGroup) {
                loopProtectionGroup.style.display = 'none';
            }
            if (loopProtectionInput) {
                loopProtectionInput.value = '';
            }
        }
    }
}

window.handleRootBridgeChange = function(value) {
    const bridgePriorityGroup = document.querySelector('[data-param="bridge_priority"]');
    const bridgePriorityInput = document.getElementById('bridge_priority');

    if (bridgePriorityGroup && bridgePriorityInput) {
        if (value === 'primary') {
            // 选择根桥时禁用桥优先级
            bridgePriorityInput.disabled = true;
            bridgePriorityInput.value = '';
            bridgePriorityGroup.style.opacity = '0.5';
        } else {
            // 其他情况启用桥优先级
            bridgePriorityInput.disabled = false;
            bridgePriorityGroup.style.opacity = '1';
        }
    }
}

window.updateStpParameters = function(stpMode) {
    // 动态更新参数显示，而不是重新加载整个表单
    const parametersContainer = document.getElementById('parametersContainer');
    const allParams = parametersContainer.querySelectorAll('[data-param]');

    // 遍历所有参数，根据STP模式显示/隐藏
    allParams.forEach(paramGroup => {
        const paramName = paramGroup.getAttribute('data-param');
        if (shouldShowStpParameter(paramName, stpMode)) {
            paramGroup.style.display = 'block';
        } else {
            paramGroup.style.display = 'none';
        }
    });

    // 如果选择了根桥，需要更新桥优先级状态
    const rootBridgeInputs = document.querySelectorAll('input[name="root_bridge_config"]');
    rootBridgeInputs.forEach(input => {
        if (input.checked) {
            handleRootBridgeChange(input.value);
        }
    });

    // 检查时间参数开关状态，确保时间参数的显示状态正确
    const timingToggle = document.getElementById('configure_timing_params');
    if (timingToggle) {
        toggleStpTimingFields(timingToggle.checked);
    }

    // 检查端口配置开关状态，确保端口参数的显示状态正确
    const portToggle = document.getElementById('configure_port_blocking');
    if (portToggle) {
        toggleStpPortFields(portToggle.checked);
    }

    // 恢复STP保护功能的接口输入框状态
    restoreStpProtectionInterfaceState();
}

// 恢复STP保护功能接口输入框状态（全局）
window.restoreStpProtectionInterfaceState = function() {
    // 恢复边缘端口接口输入框状态
    const edgePortTrue = document.getElementById('edge_port_true');
    if (edgePortTrue && edgePortTrue.checked) {
        handleEdgePortChange(true);
    }

    // 恢复根保护接口输入框状态
    const rootProtectionTrue = document.getElementById('root_protection_true');
    if (rootProtectionTrue && rootProtectionTrue.checked) {
        handleProtectionChange('root', true);
    }

    // 恢复环路保护接口输入框状态
    const loopProtectionTrue = document.getElementById('loop_protection_true');
    if (loopProtectionTrue && loopProtectionTrue.checked) {
        handleProtectionChange('loop', true);
    }
}

// 验证端口冲突（全局）
window.validatePortConflicts = function(currentType) {
    const edgePortInput = document.getElementById('edge_port_interface');
    const rootProtectionInput = document.getElementById('root_protection_interface');
    const loopProtectionInput = document.getElementById('loop_protection_interface');

    const edgePortEnabled = document.getElementById('edge_port_true')?.checked;
    const rootProtectionEnabled = document.getElementById('root_protection_true')?.checked;
    const loopProtectionEnabled = document.getElementById('loop_protection_true')?.checked;

    // 获取当前输入的端口列表
    const edgePorts = edgePortEnabled && edgePortInput?.value ? expandPortRange(edgePortInput.value) : [];
    const rootPorts = rootProtectionEnabled && rootProtectionInput?.value ? expandPortRange(rootProtectionInput.value) : [];
    const loopPorts = loopProtectionEnabled && loopProtectionInput?.value ? expandPortRange(loopProtectionInput.value) : [];

    // 清除之前的错误状态
    clearPortValidationErrors();

    let hasConflict = false;

    // 检查边缘端口与环路保护的冲突
    if (edgePortEnabled && loopProtectionEnabled) {
        const edgeLoopConflicts = findPortConflicts(edgePorts, loopPorts);
        if (edgeLoopConflicts.length > 0) {
            showPortConflictError('edge_port_interface', `端口 ${edgeLoopConflicts.join(', ')} 与环路保护冲突`);
            showPortConflictError('loop_protection_interface', `端口 ${edgeLoopConflicts.join(', ')} 与边缘端口冲突`);
            hasConflict = true;
        }
    }

    // 检查根保护与环路保护的冲突
    if (rootProtectionEnabled && loopProtectionEnabled) {
        const rootLoopConflicts = findPortConflicts(rootPorts, loopPorts);
        if (rootLoopConflicts.length > 0) {
            showPortConflictError('root_protection_interface', `端口 ${rootLoopConflicts.join(', ')} 与环路保护冲突`);
            showPortConflictError('loop_protection_interface', `端口 ${rootLoopConflicts.join(', ')} 与根保护冲突`);
            hasConflict = true;
        }
    }

    return !hasConflict;
}

// 展开端口范围（简化版，用于冲突检测）
function expandPortRange(portString) {
    if (!portString) return [];

    const ports = [];
    const parts = portString.split(',');

    parts.forEach(part => {
        part = part.trim();
        if (part.includes('-')) {
            const match = part.match(/^(.+?)(\d+)-(\d+)$/);
            if (match) {
                const prefix = match[1];
                const start = parseInt(match[2]);
                const end = parseInt(match[3]);
                for (let i = start; i <= end; i++) {
                    ports.push(prefix + i);
                }
            }
        } else {
            ports.push(part);
        }
    });

    return ports;
}

// 查找端口冲突
function findPortConflicts(ports1, ports2) {
    return ports1.filter(port => ports2.includes(port));
}

// 显示端口冲突错误
function showPortConflictError(inputId, message) {
    const input = document.getElementById(inputId);
    const errorDiv = document.getElementById(inputId + '_error');

    if (input) {
        input.classList.add('is-invalid');
    }

    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }
}

// 清除端口验证错误
function clearPortValidationErrors() {
    const inputs = ['edge_port_interface', 'root_protection_interface', 'loop_protection_interface'];

    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        const errorDiv = document.getElementById(inputId + '_error');

        if (input) {
            input.classList.remove('is-invalid');
        }

        if (errorDiv) {
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
        }
    });
}

// 验证桥优先级（必须是4096的倍数）（全局）
window.validateBridgePriority = function(input) {
    const value = parseInt(input.value);
    const errorDiv = document.getElementById(input.id + '_error');

    if (input.value === '') {
        // 空值是允许的
        input.classList.remove('is-invalid');
        if (errorDiv) errorDiv.textContent = '';
        return true;
    }

    if (isNaN(value) || value < 0 || value > 61440) {
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = '值必须在0-61440范围内';
        return false;
    }

    if (value % 4096 !== 0) {
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = '桥优先级必须是4096的倍数（如：0, 4096, 8192, 12288...）';
        return false;
    }

    input.classList.remove('is-invalid');
    if (errorDiv) errorDiv.textContent = '';
    return true;
}

// 验证端口优先级（必须是16的倍数）（全局）
window.validatePortPriority = function(input) {
    const value = parseInt(input.value);
    const errorDiv = document.getElementById(input.id + '_error');

    if (input.value === '') {
        // 空值是允许的
        input.classList.remove('is-invalid');
        if (errorDiv) errorDiv.textContent = '';
        return true;
    }

    if (isNaN(value) || value < 0 || value > 240) {
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = '值必须在0-240范围内';
        return false;
    }

    if (value % 16 !== 0) {
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = '端口优先级必须是16的倍数（如：0, 16, 32, 48...）';
        return false;
    }

    input.classList.remove('is-invalid');
    if (errorDiv) errorDiv.textContent = '';
    return true;
}

// 验证Hello时间（1-10秒）（全局）
window.validateHelloTime = function(input) {
    const value = parseInt(input.value);
    const errorDiv = document.getElementById(input.id + '_error');

    if (input.value === '') {
        input.classList.remove('is-invalid');
        if (errorDiv) errorDiv.textContent = '';
        return true;
    }

    if (isNaN(value) || value < 1 || value > 10) {
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = 'Hello时间必须在1-10秒范围内，建议值：2秒';
        return false;
    }

    input.classList.remove('is-invalid');
    if (errorDiv) errorDiv.textContent = '';
    return true;
}

// 验证转发延迟时间（4-30秒）（全局）
window.validateForwardDelay = function(input) {
    const value = parseInt(input.value);
    const errorDiv = document.getElementById(input.id + '_error');

    if (input.value === '') {
        input.classList.remove('is-invalid');
        if (errorDiv) errorDiv.textContent = '';
        return true;
    }

    if (isNaN(value) || value < 4 || value > 30) {
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = '转发延迟时间必须在4-30秒范围内，建议值：15秒';
        return false;
    }

    input.classList.remove('is-invalid');
    if (errorDiv) errorDiv.textContent = '';
    return true;
}

// 验证最大老化时间（6-40秒）（全局）
window.validateMaxAge = function(input) {
    const value = parseInt(input.value);
    const errorDiv = document.getElementById(input.id + '_error');

    if (input.value === '') {
        input.classList.remove('is-invalid');
        if (errorDiv) errorDiv.textContent = '';
        return true;
    }

    if (isNaN(value) || value < 6 || value > 40) {
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = '最大老化时间必须在6-40秒范围内，建议值：20秒';
        return false;
    }

    // 检查时间参数的逻辑关系
    const helloTimeInput = document.getElementById('hello_time');
    const forwardDelayInput = document.getElementById('forward_delay');

    if (helloTimeInput && helloTimeInput.value) {
        const helloTime = parseInt(helloTimeInput.value);
        if (value < 2 * (helloTime + 1)) {
            input.classList.add('is-invalid');
            if (errorDiv) errorDiv.textContent = `最大老化时间必须 ≥ 2 × (Hello时间 + 1) = ${2 * (helloTime + 1)}秒`;
            return false;
        }
    }

    if (forwardDelayInput && forwardDelayInput.value) {
        const forwardDelay = parseInt(forwardDelayInput.value);
        if (value < forwardDelay) {
            input.classList.add('is-invalid');
            if (errorDiv) errorDiv.textContent = '最大老化时间必须 ≥ 转发延迟时间';
            return false;
        }
    }

    input.classList.remove('is-invalid');
    if (errorDiv) errorDiv.textContent = '';
    return true;
}

// 验证修订级别（0-65535）（全局）
window.validateRevisionLevel = function(input) {
    const value = parseInt(input.value);
    const errorDiv = document.getElementById(input.id + '_error');

    if (input.value === '') {
        input.classList.remove('is-invalid');
        if (errorDiv) errorDiv.textContent = '';
        return true;
    }

    if (isNaN(value) || value < 0 || value > 65535) {
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = 'MSTP修订级别必须在0-65535范围内';
        return false;
    }

    input.classList.remove('is-invalid');
    if (errorDiv) errorDiv.textContent = '';
    return true;
}

// 验证MSTP实例ID（1-64）（全局）
window.validateInstanceId = function(input) {
    const value = parseInt(input.value);
    const errorDiv = document.getElementById(input.id + '_error');

    if (input.value === '') {
        input.classList.remove('is-invalid');
        if (errorDiv) errorDiv.textContent = '';
        return true;
    }

    if (isNaN(value) || value < 1 || value > 64) {
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = 'MSTP实例ID必须在1-64范围内';
        return false;
    }

    input.classList.remove('is-invalid');
    if (errorDiv) errorDiv.textContent = '';
    return true;
}

// 验证端口路径开销（1-200000000）（全局）
window.validatePortCost = function(input) {
    const value = parseInt(input.value);
    const errorDiv = document.getElementById(input.id + '_error');

    if (input.value === '') {
        input.classList.remove('is-invalid');
        if (errorDiv) errorDiv.textContent = '';
        return true;
    }

    if (isNaN(value) || value < 1 || value > 200000000) {
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = '端口路径开销必须在1-200000000范围内';
        return false;
    }

    // 提供常见端口类型的建议值
    let suggestion = '';
    if (value >= 1000000 && value <= 20000000) {
        suggestion = ' (10M以太网建议值：100-2000000)';
    } else if (value >= 100000 && value <= 2000000) {
        suggestion = ' (100M以太网建议值：10000-200000)';
    } else if (value >= 10000 && value <= 200000) {
        suggestion = ' (1G以太网建议值：1000-20000)';
    } else if (value >= 1000 && value <= 20000) {
        suggestion = ' (10G以太网建议值：100-2000)';
    }

    input.classList.remove('is-invalid');
    if (errorDiv) errorDiv.textContent = suggestion;
    return true;
}

// 通用STP整数验证函数（全局）
window.validateStpInteger = function(input, min, max) {
    const value = parseInt(input.value);
    const errorDiv = document.getElementById(input.id + '_error');

    if (input.value === '') {
        input.classList.remove('is-invalid');
        if (errorDiv) errorDiv.textContent = '';
        return true;
    }

    if (isNaN(value)) {
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = '请输入有效的数字';
        return false;
    }

    if (value < min || value > max) {
        input.classList.add('is-invalid');
        if (errorDiv) errorDiv.textContent = `值必须在${min}-${max}范围内`;
        return false;
    }

    input.classList.remove('is-invalid');
    if (errorDiv) errorDiv.textContent = '';
    return true;
}
</script>
{% endblock %}
