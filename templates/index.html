{% extends "base.html" %}

{% block title %}è®¾å¤‡é…ç½®å‘å¯¼ - äº¤æ¢æœºé…ç½®å‘½ä»¤ç”Ÿæˆå¹³å°{% endblock %}

{% block extra_css %}
<style>
/* ç®€åŒ–çš„å…¨å±å¸ƒå±€ */
.wizard-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    display: flex;
    flex-direction: column;
}

/* é¡¶éƒ¨å¯¼èˆª */
.top-nav {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-title h1 {
    font-size: 2rem;
    margin: 0;
}

.vendor-selector {
    display: flex;
    gap: 1rem;
}

.vendor-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.vendor-btn.active, .vendor-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
}

.vendor-btn.disabled {
    opacity: 0.6;
    cursor: not-allowed;
    pointer-events: none;
}

.vendor-btn.disabled:hover {
    transform: none;
    background: rgba(255,255,255,0.1);
}

/* æ­¥éª¤å¯¼èˆª */
.steps-nav {
    background: white;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: center;
    gap: 2rem;
}

.step {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.3s;
}

.step.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.step.active .step-number {
    background: rgba(255,255,255,0.2);
    color: white;
}

/* ä¸»å†…å®¹åŒº */
.main-content {
    flex: 1;
    padding: 2rem;
}

.step-content {
    display: none;
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.step-content.active {
    display: block;
}

/* ä¸‰å¤§ç±»æ¨¡å—é€‰æ‹©ç½‘æ ¼ */
.modules-selection-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
    margin-top: 2rem;
}

.module-category-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 2px solid #e9ecef;
    border-radius: 20px;
    padding: 0;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    min-height: 400px;
    display: flex;
    flex-direction: column;
}

.module-category-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.module-category-card:hover::before {
    transform: scaleX(1);
}

.module-category-card:hover {
    border-color: #667eea;
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2);
    transform: translateY(-5px);
}

.category-header-card {
    text-align: center;
    padding: 2rem 1.5rem 1.5rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 2px solid #e9ecef;
}

.category-icon-large {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.category-icon-large i {
    font-size: 2.5rem;
    color: white;
}

.category-title-card {
    font-size: 1.5rem;
    font-weight: 700;
    color: #495057;
    margin-bottom: 0.75rem;
}

.category-description-card {
    color: #6c757d;
    font-size: 1rem;
    line-height: 1.5;
    margin: 0;
}

.modules-list-card {
    flex: 1;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.module-item-card {
    background: #f8f9fa;
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.module-item-card:hover {
    background: #e9ecef;
    border-color: #667eea;
    transform: translateX(5px);
}

.module-item-card.selected {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
    border-color: #667eea;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
}

.module-checkbox-card {
    width: 24px;
    height: 24px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    position: relative;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.module-checkbox-card.checked {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: #667eea;
}

.module-checkbox-card.checked::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    font-size: 14px;
}

.module-info-card {
    flex: 1;
}

.module-name-card {
    font-size: 1rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.25rem;
}

.module-desc-card {
    font-size: 0.85rem;
    color: #6c757d;
    line-height: 1.4;
    margin: 0;
}

/* é…ç½®è¡¨å• */
.config-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 10px;
    border: 1px solid #e9ecef;
}

.config-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* å¼€å…³æ§åˆ¶æ ·å¼ */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #dc3545;  /* é»˜è®¤çº¢è‰²è¡¨ç¤ºå…³é—­ */
    transition: 0.3s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);  /* å¯ç”¨æ—¶ç»¿è‰²æ¸å˜ */
}

input:checked + .toggle-slider:before {
    transform: translateX(26px);
}

/* ç«¯å£è¾“å…¥ç»„åˆæ§ä»¶ */
.port-input-group {
    margin-bottom: 1rem;
}

.port-input-group .row {
    align-items: end;
}

.port-prefix-select {
    width: 100%;
}

.port-number-input {
    width: 100%;
}

/* åˆ é™¤äº†port-previewæ ·å¼ */

/* æ¡ä»¶æ˜¾ç¤ºæ§ä»¶ */
.conditional-field {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(102, 126, 234, 0.05);
    border-left: 4px solid #667eea;
    border-radius: 0 6px 6px 0;
}

.conditional-field.show {
    display: block;
    animation: slideDown 0.3s ease;
}

/* æ•°ç»„å­—æ®µæ ·å¼ */
.array-field {
    margin-bottom: 1.5rem;
}

.array-container {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    min-height: 80px;
    transition: all 0.3s ease;
}

.array-container:hover {
    border-color: #007bff;
    background: #f0f8ff;
}

.array-item {
    background: white;
    border: 1px solid #e9ecef;
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
}

.array-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.array-item:last-child {
    margin-bottom: 0;
}

.array-item .btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
}

.array-item .btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
}

/* ç«¯å£æ¨¡å¼ç›¸å…³å­—æ®µ */
.port-mode-fields {
    background: rgba(40, 167, 69, 0.05);
    border-left: 4px solid #28a745;
}

.trunk-only-field {
    margin-top: 1rem;
    padding: 0.75rem;
    background: rgba(255, 193, 7, 0.1);
    border-left: 3px solid #ffc107;
    border-radius: 0 4px 4px 0;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* è¡¨å•åˆ†ç»„ */
.form-group {
    margin-bottom: 1.5rem;
}

.form-group-title {
    font-weight: 600;
    color: #495057;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* é¢„è§ˆåŒºåŸŸ */
.preview-container {
    background: #2d3748;
    border-radius: 10px;
    overflow: hidden;
}

.preview-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.preview-content {
    padding: 1.5rem;
    font-family: 'Courier New', monospace;
    color: #e2e8f0;
    font-size: 0.9rem;
    line-height: 1.5;
    max-height: 400px;
    overflow-y: auto;
}

.config-module-section {
    margin-bottom: 2rem;
}

.config-module-section:last-child {
    margin-bottom: 0;
}

.config-module-section h5 {
    color: #a0aec0;
    font-size: 1rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #4a5568;
}

.config-commands {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 6px;
    padding: 1rem;
}

.command-line {
    color: #e2e8f0;
    margin-bottom: 0.25rem;
    padding: 0.25rem 0;
    border-left: 3px solid transparent;
    padding-left: 0.5rem;
    transition: all 0.3s ease;
}

.command-line:hover {
    background: rgba(102, 126, 234, 0.2);
    border-left-color: #667eea;
}

/* åº•éƒ¨å¯¼èˆª */
.bottom-nav {
    background: white;
    padding: 1.5rem 2rem;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.nav-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.nav-btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.nav-btn-secondary {
    background: #6c757d;
    color: white;
}

.nav-btn:hover:not(:disabled) {
    transform: translateY(-2px);
}

.nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1400px) {
    .modules-selection-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 1024px) {
    .modules-selection-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    .module-category-card {
        min-height: auto;
    }

    .category-icon-large {
        width: 60px;
        height: 60px;
    }

    .category-icon-large i {
        font-size: 2rem;
    }
}

@media (max-width: 768px) {
    .top-nav {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
    }

    .vendor-selector {
        flex-wrap: wrap;
        justify-content: center;
    }

    .vendor-btn {
        flex: 1;
        min-width: 120px;
    }

    .steps-nav {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
    }

    .step {
        justify-content: center;
    }

    .main-content {
        padding: 1rem;
    }

    .modules-selection-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .module-category-card {
        min-height: auto;
    }

    .category-header-card {
        padding: 1.5rem 1rem 1rem;
    }

    .category-icon-large {
        width: 50px;
        height: 50px;
    }

    .category-icon-large i {
        font-size: 1.5rem;
    }

    .category-title-card {
        font-size: 1.2rem;
    }

    .modules-list-card {
        padding: 1rem;
    }

    .module-item-card {
        padding: 0.75rem;
    }

    .module-name-card {
        font-size: 0.9rem;
    }

    .module-desc-card {
        font-size: 0.8rem;
    }

    .bottom-nav {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
    }

    .nav-btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="top-nav">
        <div class="nav-title">
            <h1><i class="fas fa-cogs me-2"></i>è®¾å¤‡é…ç½®å‘å¯¼</h1>
        </div>
        <div class="vendor-selector">
            <button class="vendor-btn active" data-vendor="huawei">åä¸º</button>
            <button class="vendor-btn" data-vendor="h3c">åä¸‰</button>
            <button class="vendor-btn" data-vendor="cisco">æ€ç§‘</button>
            <button class="vendor-btn" data-vendor="ruijie">é”æ·</button>
        </div>
    </div>

    <!-- æ­¥éª¤å¯¼èˆª -->
    <div class="steps-nav">
        <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <span>é€‰æ‹©æ¨¡å—</span>
        </div>
        <div class="step" data-step="2">
            <div class="step-number">2</div>
            <span>é…ç½®å‚æ•°</span>
        </div>
        <div class="step" data-step="3">
            <div class="step-number">3</div>
            <span>ç”Ÿæˆè„šæœ¬</span>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <!-- æ­¥éª¤1ï¼šé€‰æ‹©æ¨¡å— -->
        <div class="step-content active" data-step="1">
            <h2>é€‰æ‹©é…ç½®æ¨¡å—</h2>
            <p>è¯·é€‰æ‹©æ‚¨éœ€è¦é…ç½®çš„åŠŸèƒ½æ¨¡å—</p>

            <div class="modules-selection-grid">
                <!-- ä»¥å¤ªç½‘äº¤æ¢é…ç½® -->
                <div class="module-category-card">
                    <div class="category-header-card">
                        <div class="category-icon-large">
                            <i class="fas fa-ethernet"></i>
                        </div>
                        <h3 class="category-title-card">ä»¥å¤ªç½‘äº¤æ¢é…ç½®</h3>
                        <p class="category-description-card">VLANç®¡ç†ã€ç«¯å£èšåˆã€ç”Ÿæˆæ ‘åè®®ç­‰äºŒå±‚äº¤æ¢åŠŸèƒ½</p>
                    </div>
                    <div class="modules-list-card">
                        <div class="module-item-card" data-module="vlan_complete_config">
                            <div class="module-checkbox-card"></div>
                            <div class="module-info-card">
                                <div class="module-name-card">VLANä¸€ä½“åŒ–é…ç½®</div>
                                <div class="module-desc-card">åˆ›å»ºvlanã€é…ç½®æ¥å£VLANå±æ€§</div>
                            </div>
                        </div>
                        <div class="module-item-card" data-module="port_aggregation">
                            <div class="module-checkbox-card"></div>
                            <div class="module-info-card">
                                <div class="module-name-card">ç«¯å£èšåˆé…ç½®</div>
                                <div class="module-desc-card">LACPã€é™æ€èšåˆã€è´Ÿè½½å‡è¡¡</div>
                            </div>
                        </div>
                        <div class="module-item-card" data-module="stp_config">
                            <div class="module-checkbox-card"></div>
                            <div class="module-info-card">
                                <div class="module-name-card">STPç”Ÿæˆæ ‘åè®®</div>
                                <div class="module-desc-card">RSTP/MSTPã€æ ¹æ¡¥ã€ç«¯å£ä¿æŠ¤</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IPä¸šåŠ¡å’Œè·¯ç”±é…ç½® -->
                <div class="module-category-card">
                    <div class="category-header-card">
                        <div class="category-icon-large">
                            <i class="fas fa-route"></i>
                        </div>
                        <h3 class="category-title-card">IPä¸šåŠ¡å’Œè·¯ç”±é…ç½®</h3>
                        <p class="category-description-card">æ¥å£IPé…ç½®ã€é™æ€è·¯ç”±ã€åŠ¨æ€è·¯ç”±ã€DHCPæœåŠ¡ç­‰ä¸‰å±‚ç½‘ç»œåŠŸèƒ½</p>
                    </div>
                    <div class="modules-list-card">
                        <div class="module-item-card" data-module="interface_ip">
                            <div class="module-checkbox-card"></div>
                            <div class="module-info-card">
                                <div class="module-name-card">æ¥å£IPé…ç½®</div>
                                <div class="module-desc-card">ä¸ºæ¥å£é…ç½®IPåœ°å€å’Œæè¿°</div>
                            </div>
                        </div>
                        <div class="module-item-card" data-module="static_route">
                            <div class="module-checkbox-card"></div>
                            <div class="module-info-card">
                                <div class="module-name-card">é™æ€è·¯ç”±é…ç½®</div>
                                <div class="module-desc-card">é…ç½®é™æ€è·¯ç”±è¡¨å’Œä¸‹ä¸€è·³</div>
                            </div>
                        </div>
                        <div class="module-item-card" data-module="ospf_config">
                            <div class="module-checkbox-card"></div>
                            <div class="module-info-card">
                                <div class="module-name-card">OSPFåŠ¨æ€è·¯ç”±</div>
                                <div class="module-desc-card">åŒºåŸŸé…ç½®ã€è®¤è¯ã€è·¯ç”±å¼•å…¥</div>
                            </div>
                        </div>
                        <div class="module-item-card" data-module="dhcp_service">
                            <div class="module-checkbox-card"></div>
                            <div class="module-info-card">
                                <div class="module-name-card">DHCPæœåŠ¡é…ç½®</div>
                                <div class="module-desc-card">åœ°å€æ± ã€æ¥å£é…ç½®ã€é€‰é¡¹è®¾ç½®</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¯é æ€§é…ç½® -->
                <div class="module-category-card">
                    <div class="category-header-card">
                        <div class="category-icon-large">
                            <i class="fas fa-shield-halved"></i>
                        </div>
                        <h3 class="category-title-card">å¯é æ€§é…ç½®</h3>
                        <p class="category-description-card">é«˜å¯ç”¨æ€§ã€å†—ä½™å¤‡ä»½ã€æ•…éšœåˆ‡æ¢ç­‰å¯é æ€§åŠŸèƒ½</p>
                    </div>
                    <div class="modules-list-card">
                        <div class="module-item-card" data-module="vrrp_config">
                            <div class="module-checkbox-card"></div>
                            <div class="module-info-card">
                                <div class="module-name-card">VRRPç½‘å…³å†—ä½™é…ç½®</div>
                                <div class="module-desc-card">è™šæ‹Ÿè·¯ç”±å†—ä½™åè®®ï¼Œç½‘å…³é«˜å¯ç”¨</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤2ï¼šé…ç½®å‚æ•° -->
        <div class="step-content" data-step="2">
            <h2>é…ç½®å‚æ•°</h2>
            <p>ä¸ºé€‰ä¸­çš„æ¨¡å—é…ç½®å…·ä½“å‚æ•°</p>
            <div id="configForms"></div>
        </div>

        <!-- æ­¥éª¤3ï¼šç”Ÿæˆè„šæœ¬ -->
        <div class="step-content" data-step="3">
            <h2>é…ç½®è„šæœ¬ç”Ÿæˆå®Œæˆ</h2>
            <p>é…ç½®è„šæœ¬å·²ç”Ÿæˆå®Œæˆï¼Œæ‚¨å¯ä»¥å¤åˆ¶æˆ–ä¸‹è½½é…ç½®è„šæœ¬</p>
            
            <div class="preview-container">
                <div class="preview-header">
                    <h3>æœ€ç»ˆé…ç½®è„šæœ¬</h3>
                    <div>
                        <button class="nav-btn nav-btn-secondary me-2" onclick="copyConfig()">å¤åˆ¶</button>
                        <button class="nav-btn nav-btn-primary" onclick="downloadConfig()">ä¸‹è½½</button>
                    </div>
                </div>
                <div class="preview-content" id="finalContent"></div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
        <button class="nav-btn nav-btn-secondary" id="prevBtn" onclick="previousStep()" disabled>
            <i class="fas fa-arrow-left me-1"></i>ä¸Šä¸€æ­¥
        </button>
        
        <div class="step-info">
            <span id="stepInfo">æ­¥éª¤ 1 / 4</span>
        </div>
        
        <button class="nav-btn nav-btn-primary" id="nextBtn" onclick="nextStep()">
            ä¸‹ä¸€æ­¥<i class="fas fa-arrow-right ms-1"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // å…¨å±€å˜é‡
    let currentStep = 1;
    let selectedModules = new Set();
    let currentVendor = 'huawei';

    // å‚å•†ç‰¹å®šçš„æ¥å£å‰ç¼€é…ç½®
    const vendorInterfacePrefixes = {
        'huawei': [
            'GigabitEthernet',
            'XGigabitEthernet',
            '10GE',
            '25GE',
            '40GE',
            '100GE',
            'Vlanif',
            'Eth-Trunk',
            'LoopBack'
        ],
        'h3c': [
            'Ethernet',
            'GigabitEthernet',
            'Ten-GigabitEthernet',
            'Twenty-FiveGigE',
            'FortyGigE',
            'HundredGigE',
            'Vlan-interface',
            'Bridge-Aggregation',
            'LoopBack'
        ],
        'cisco': [
            'FastEthernet',
            'GigabitEthernet',
            'TenGigabitEthernet',
            'TwentyFiveGigE',
            'FortyGigabitEthernet',
            'HundredGigE',
            'Vlan',
            'Port-channel',
            'Loopback'
        ],
        'ruijie': [
            'FastEthernet',
            'GigabitEthernet',
            'TenGigabitEthernet',
            'TwentyFiveGigE',
            'FortyGigabitEthernet',
            'HundredGigE',
            'Vlan',
            'AggregatePort',
            'Loopback'
        ]
    };

    // åˆå§‹åŒ–
    init();

    function init() {
        bindEvents();
        updateUI();
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // å‚å•†é€‰æ‹©
        document.querySelectorAll('.vendor-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // åªå…è®¸åœ¨æ¨¡å—é€‰æ‹©é¡µé¢ï¼ˆæ­¥éª¤1ï¼‰ç‚¹å‡»å‚å•†å¡ç‰‡
                if (currentStep !== 1) {
                    console.log('å‚å•†é€‰æ‹©ä»…åœ¨æ¨¡å—é€‰æ‹©é¡µé¢å¯ç”¨');
                    return;
                }

                document.querySelectorAll('.vendor-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentVendor = this.dataset.vendor;

                // æ›´æ–°å­—æ®µæ ‡ç­¾
                updateFieldLabels();

                // æ›´æ–°ç«¯å£å‰ç¼€é€‰é¡¹
                updateAllPortPrefixes();
            });
        });

        // æ¨¡å—é€‰æ‹© - æ”¯æŒæ–°çš„ä¸‰å¤§ç±»ç»“æ„
        document.querySelectorAll('.module-item-card').forEach(card => {
            card.addEventListener('click', function() {
                const moduleId = this.dataset.module;
                const checkbox = this.querySelector('.module-checkbox-card');

                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    checkbox.classList.remove('checked');
                    selectedModules.delete(moduleId);
                } else {
                    this.classList.add('selected');
                    checkbox.classList.add('checked');
                    selectedModules.add(moduleId);
                }
                updateUI();
            });
        });
    }

    // æ­¥éª¤å¯¼èˆª
    async function nextStep() {
        if (currentStep === 1 && selectedModules.size === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé…ç½®æ¨¡å—');
            return;
        }

        if (currentStep < 3) {
            currentStep++;
            updateUI();

            try {
                if (currentStep === 2) {
                    await generateConfigForms();
                }
                if (currentStep === 3) {
                    await generateFinalConfig();
                }
            } catch (error) {
                console.error('æ­¥éª¤å¤„ç†å¤±è´¥:', error);
                alert('å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è¾“å…¥å‚æ•°');
            }
        }
    }

    function previousStep() {
        if (currentStep > 1) {
            currentStep--;
            updateUI();
        }
    }

    // æ›´æ–°UI
    function updateUI() {
        // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
        document.querySelectorAll('.step').forEach((step, index) => {
            step.classList.toggle('active', index + 1 === currentStep);
        });

        // æ›´æ–°æ­¥éª¤å†…å®¹
        document.querySelectorAll('.step-content').forEach((content, index) => {
            content.classList.toggle('active', index + 1 === currentStep);
        });

        // æ›´æ–°å¯¼èˆªæŒ‰é’®
        document.getElementById('prevBtn').disabled = currentStep === 1;
        document.getElementById('nextBtn').disabled = currentStep === 1 && selectedModules.size === 0;
        document.getElementById('nextBtn').style.display = currentStep === 3 ? 'none' : 'block';
        document.getElementById('stepInfo').textContent = `æ­¥éª¤ ${currentStep} / 3`;

        // æ›´æ–°å‚å•†æŒ‰é’®çŠ¶æ€
        updateVendorButtonsState();
    }

    // ç”Ÿæˆé…ç½®è¡¨å• - ä¸åç«¯APIé›†æˆ
    async function generateConfigForms() {
        console.log('ğŸ”§ å¼€å§‹ç”Ÿæˆé…ç½®è¡¨å•');
        console.log('é€‰ä¸­çš„æ¨¡å—:', Array.from(selectedModules));
        console.log('å½“å‰å‚å•†:', currentVendor);

        const container = document.getElementById('configForms');
        console.log('è¡¨å•å®¹å™¨:', container);

        let html = '';

        if (selectedModules.size === 0) {
            console.log('âŒ æ²¡æœ‰é€‰ä¸­ä»»ä½•æ¨¡å—ï¼Œæ— æ³•ç”Ÿæˆè¡¨å•');
            container.innerHTML = '<div class="text-warning">è¯·å…ˆé€‰æ‹©é…ç½®æ¨¡å—</div>';
            return;
        }

        for (const moduleId of selectedModules) {
            console.log(`\nğŸ“‹ ç”Ÿæˆæ¨¡å—è¡¨å•: ${moduleId}`);
            try {
                // ä»åç«¯è·å–æ¨¡æ¿ä¿¡æ¯
                console.log(`è·å–æ¨¡æ¿ä¿¡æ¯: ${currentVendor}/${moduleId}`);
                const templateInfo = await getTemplateInfo(currentVendor, moduleId);
                console.log('æ¨¡æ¿ä¿¡æ¯:', templateInfo);

                const moduleForm = generateFormForModule(moduleId, templateInfo);
                console.log(`ç”Ÿæˆçš„è¡¨å•HTMLé•¿åº¦: ${moduleForm.length}`);
                html += moduleForm;
            } catch (error) {
                console.error(`è·å–æ¨¡å— ${moduleId} çš„æ¨¡æ¿ä¿¡æ¯å¤±è´¥:`, error);
                // ä½¿ç”¨é»˜è®¤è¡¨å•
                const defaultForm = generateDefaultForm(moduleId);
                console.log(`ä½¿ç”¨é»˜è®¤è¡¨å•ï¼ŒHTMLé•¿åº¦: ${defaultForm.length}`);
                html += defaultForm;
            }
        }

        console.log(`æ€»HTMLé•¿åº¦: ${html.length}`);
        console.log('è®¾ç½®è¡¨å•HTMLåˆ°å®¹å™¨');
        container.innerHTML = html;

        // éªŒè¯è¡¨å•æ˜¯å¦æ­£ç¡®ç”Ÿæˆ
        setTimeout(() => {
            console.log('éªŒè¯è¡¨å•ç”Ÿæˆç»“æœ:');
            selectedModules.forEach(moduleId => {
                const formSection = document.querySelector(`[data-module="${moduleId}"]`);
                console.log(`æ¨¡å— ${moduleId} çš„è¡¨å•åŒºåŸŸ:`, formSection);
                if (formSection) {
                    const inputs = formSection.querySelectorAll('input, select, textarea');
                    console.log(`  æ‰¾åˆ° ${inputs.length} ä¸ªè¾“å…¥æ§ä»¶`);
                } else {
                    console.log(`  âŒ æ‰¾ä¸åˆ°æ¨¡å— ${moduleId} çš„è¡¨å•åŒºåŸŸ`);
                }
            });
        }, 50);

        // åˆå§‹åŒ–è¡¨å•æ§ä»¶
        setTimeout(() => {
            console.log('åˆå§‹åŒ–è¡¨å•æ§ä»¶');
            initializeFormControls();
        }, 100);
    }

    // åˆå§‹åŒ–è¡¨å•æ§ä»¶
    function initializeFormControls() {
        // åˆå§‹åŒ–å¼€å…³æ§åˆ¶çš„æ¡ä»¶å­—æ®µæ˜¾ç¤ºçŠ¶æ€
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            if (checkbox.name) {
                handleToggleChange(checkbox.name, checkbox.checked);
            }
        });

        // åˆå§‹åŒ–ä¸‹æ‹‰é€‰æ‹©çš„æ¡ä»¶å­—æ®µæ˜¾ç¤ºçŠ¶æ€
        document.querySelectorAll('select').forEach(select => {
            if (select.name && select.name === 'dhcp_type') {
                handleSelectChange(select.name, select.value);
            }
        });

        // åˆå§‹åŒ–ç«¯å£é¢„è§ˆ
        document.querySelectorAll('.port-input-group').forEach(group => {
            const hiddenInput = group.querySelector('input[type="hidden"]');
            if (hiddenInput && hiddenInput.name) {
                updatePortPreview(hiddenInput.name);
            }
        });

        // åˆå§‹åŒ–å­—æ®µæ ‡ç­¾
        updateFieldLabels();
    }

    // ä»åç«¯è·å–æ¨¡æ¿ä¿¡æ¯
    async function getTemplateInfo(vendor, configType) {
        const response = await fetch(`/api/template_info/${vendor}/${configType}`);
        const data = await response.json();
        if (data.success) {
            return data.template_info;
        } else {
            throw new Error(data.error);
        }
    }

    // æ ¹æ®æ¨¡æ¿ä¿¡æ¯ç”Ÿæˆè¡¨å•
    function generateFormForModule(moduleId, templateInfo) {
        let html = `
            <div class="config-section" data-module="${moduleId}">
                <div class="config-title">
                    <i class="fas fa-cog me-2"></i>${getModuleName(moduleId)}
                </div>
        `;

        if (templateInfo && templateInfo.parameters) {
            // æ ¹æ®æ¨¡å—ç±»å‹ç”Ÿæˆç‰¹å®šçš„è¡¨å•ç»“æ„
            html += generateModuleSpecificForm(moduleId, templateInfo.parameters);
        } else {
            // é»˜è®¤è¡¨å•å­—æ®µ
            html += generateDefaultForm(moduleId);
        }

        html += '</div>';
        return html;
    }

    // ç”Ÿæˆæ¨¡å—ç‰¹å®šçš„è¡¨å•ç»“æ„
    function generateModuleSpecificForm(moduleId, parameters) {
        let html = '';

        if (moduleId === 'vlan_complete_config') {
            html += generateVlanConfigForm(parameters);
        } else if (moduleId === 'interface_ip') {
            html += generateInterfaceIpForm(parameters);
        } else if (moduleId === 'static_route') {
            html += generateStaticRouteForm(parameters);
        } else if (moduleId === 'dhcp_service') {
            html += generateDhcpServiceForm(parameters);
        } else if (moduleId === 'vrrp_config') {
            html += generateVrrpConfigForm(parameters);
        } else if (moduleId === 'port_aggregation') {
            html += generatePortAggregationForm(parameters);
        } else if (moduleId === 'stp_config') {
            html += generateStpConfigForm(parameters);
        } else if (moduleId === 'ospf_config') {
            html += generateOspfConfigForm(parameters);
        } else {
            // é€šç”¨è¡¨å•ç”Ÿæˆ
            html += generateGenericForm(parameters);
        }

        return html;
    }

    // ç”ŸæˆVLANé…ç½®è¡¨å•
    function generateVlanConfigForm(parameters) {
        let html = '';

        // åŸºç¡€VLANé…ç½®ç»„
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-layer-group me-2"></i>åŸºç¡€VLANé…ç½®
            </div>`;

        // åˆ›å»ºVLANå¼€å…³
        if (parameters.create_vlan) {
            html += generateFormField('create_vlan', parameters.create_vlan);
        }

        // VLAN IDå’Œåç§°ï¼ˆä¾èµ–äºcreate_vlanï¼‰
        html += `<div class="conditional-field" data-depends-on="create_vlan">`;
        if (parameters.vlan_id) {
            html += generateFormField('vlan_id', parameters.vlan_id);
        }
        if (parameters.vlan_name) {
            html += generateFormField('vlan_name', parameters.vlan_name);
        }
        html += `</div>`;

        html += `</div>`;

        // æ¥å£é…ç½®ç»„
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-ethernet me-2"></i>æ¥å£é…ç½®
            </div>`;

        // é…ç½®æ¥å£å¼€å…³
        if (parameters.configure_interface) {
            html += generateFormField('configure_interface', parameters.configure_interface);
        }

        // æ¥å£ç›¸å…³å‚æ•°ï¼ˆä¾èµ–äºconfigure_interfaceï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_interface">`;
        if (parameters.interface) {
            html += generateFormField('interface', parameters.interface);
        }
        if (parameters.port_mode) {
            html += generateFormField('port_mode', parameters.port_mode);
        }

        // ç«¯å£æ¨¡å¼ç›¸å…³å­—æ®µï¼ˆä¾èµ–äºport_modeé€‰æ‹©ï¼‰
        html += `<div class="conditional-field port-mode-fields" data-depends-on="port_mode" style="display: none;">`;

        // PVIDå­—æ®µï¼ˆaccesså’Œtrunkæ¨¡å¼éƒ½éœ€è¦ï¼Œä½†æ ‡ç­¾ä¸åŒï¼‰
        if (parameters.pvid) {
            html += generateFormField('pvid', parameters.pvid);
        }

        // å…è®¸VLANå­—æ®µï¼ˆä»…trunkæ¨¡å¼éœ€è¦ï¼‰
        if (parameters.allowed_vlans) {
            html += `<div class="trunk-only-field" style="display: none;">`;
            html += generateFormField('allowed_vlans', parameters.allowed_vlans);
            html += `</div>`;
        }

        html += `</div>`;
        html += `</div>`;

        html += `</div>`;

        // åˆ é™¤äº†VLANæ¥å£IPé…ç½®ç»„

        return html;
    }

    // ç”Ÿæˆæ¥å£IPé…ç½®è¡¨å•
    function generateInterfaceIpForm(parameters) {
        let html = `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-network-wired me-2"></i>æ¥å£IPé…ç½®
            </div>`;

        // æ¥å£IPé…ç½®å¼€å…³
        if (parameters.enable_interface_ip) {
            html += generateFormField('enable_interface_ip', parameters.enable_interface_ip);
        }

        // æ¥å£IPé…ç½®å‚æ•°ï¼ˆä¾èµ–äºenable_interface_ipï¼‰
        html += `<div class="conditional-field" data-depends-on="enable_interface_ip">`;
        const interfaceParams = ['interface_entries'];
        interfaceParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        // å…¶ä»–å‚æ•°
        const excludeParams = ['enable_interface_ip', 'interface_entries'];
        const sortedParams = Object.entries(parameters)
            .filter(([paramName]) => !excludeParams.includes(paramName))
            .sort(([,a], [,b]) => (a.order || 999) - (b.order || 999));

        if (sortedParams.length > 0) {
            sortedParams.forEach(([paramName, param]) => {
                html += generateFormField(paramName, param);
            });
        }

        html += `</div>`;
        return html;
    }

    // ç”Ÿæˆé™æ€è·¯ç”±é…ç½®è¡¨å•
    function generateStaticRouteForm(parameters) {
        let html = `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-route me-2"></i>é™æ€è·¯ç”±é…ç½®
            </div>`;

        // é™æ€è·¯ç”±é…ç½®å¼€å…³
        if (parameters.enable_static_route) {
            html += generateFormField('enable_static_route', parameters.enable_static_route);
        }

        // é™æ€è·¯ç”±é…ç½®å‚æ•°ï¼ˆä¾èµ–äºenable_static_routeï¼‰
        html += `<div class="conditional-field" data-depends-on="enable_static_route">`;
        const routeParams = ['route_entries'];
        routeParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        // å…¶ä»–å‚æ•°
        const excludeParams = ['enable_static_route', 'route_entries'];
        const sortedParams = Object.entries(parameters)
            .filter(([paramName]) => !excludeParams.includes(paramName))
            .sort(([,a], [,b]) => (a.order || 999) - (b.order || 999));

        if (sortedParams.length > 0) {
            sortedParams.forEach(([paramName, param]) => {
                html += generateFormField(paramName, param);
            });
        }

        html += `</div>`;
        return html;
    }

    // ç”ŸæˆDHCPæœåŠ¡é…ç½®è¡¨å•
    function generateDhcpServiceForm(parameters) {
        let html = '';

        // DHCPæœåŠ¡å™¨é…ç½®ç»„
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-server me-2"></i>DHCPæœåŠ¡å™¨é…ç½®
            </div>`;

        // DHCPæœåŠ¡å¼€å…³
        if (parameters.enable_dhcp_server) {
            html += generateFormField('enable_dhcp_server', parameters.enable_dhcp_server);
        }

        // DHCPæœåŠ¡å™¨ç›¸å…³å‚æ•°ï¼ˆä¾èµ–äºenable_dhcp_serverï¼‰
        html += `<div class="conditional-field" data-depends-on="enable_dhcp_server">`;

        // åä¸ºç‰¹æœ‰çš„åœ°å€æ± ç±»å‹é€‰æ‹©
        if (currentVendor === 'huawei' && parameters.dhcp_type) {
            html += generateFormField('dhcp_type', parameters.dhcp_type);
        }

        // æ ¹æ®å‚å•†æ˜¾ç¤ºä¸åŒçš„å‚æ•°
        if (currentVendor === 'huawei') {
            // åä¸ºï¼šæ ¹æ®åœ°å€æ± ç±»å‹æ˜¾ç¤ºä¸åŒå‚æ•°

            // å…¨å±€åœ°å€æ± å‚æ•°ï¼ˆä¾èµ–äºdhcp_typeä¸ºglobalï¼‰
            html += `<div class="conditional-field" data-depends-on="dhcp_type" data-depends-value="global">`;
            const globalParams = ['pool_name', 'network', 'mask', 'gateway', 'dns_servers', 'excluded_addresses', 'lease_time'];
            globalParams.forEach(paramName => {
                if (parameters[paramName]) {
                    html += generateFormField(paramName, parameters[paramName]);
                }
            });
            html += `</div>`;

            // æ¥å£åœ°å€æ± å‚æ•°ï¼ˆä¾èµ–äºdhcp_typeä¸ºinterfaceï¼‰
            html += `<div class="conditional-field" data-depends-on="dhcp_type" data-depends-value="interface">`;
            const interfaceParams = ['vlanif', 'interface_ip', 'interface_description', 'gateway', 'dns_servers', 'excluded_addresses', 'lease_time'];
            interfaceParams.forEach(paramName => {
                if (parameters[paramName]) {
                    html += generateFormField(paramName, parameters[paramName]);
                }
            });
            html += `</div>`;
        } else {
            // H3Cã€æ€ç§‘ã€é”æ·ï¼šç»Ÿä¸€çš„åœ°å€æ± æ¨¡å¼
            const serverParams = ['pool_name', 'network', 'mask', 'gateway', 'dns_servers', 'excluded_addresses', 'lease_time'];
            serverParams.forEach(paramName => {
                if (parameters[paramName]) {
                    html += generateFormField(paramName, parameters[paramName]);
                }
            });

            // æ¥å£é…ç½®å‚æ•°ï¼ˆH3Cã€æ€ç§‘ã€é”æ·ï¼‰
            if (parameters.enable_interface) {
                html += generateFormField('enable_interface', parameters.enable_interface);
            }

            // æ¥å£é…ç½®å‚æ•°ï¼ˆä¾èµ–äºenable_interfaceï¼‰
            html += `<div class="conditional-field" data-depends-on="enable_interface">`;
            const interfaceParams = ['interface'];
            interfaceParams.forEach(paramName => {
                if (parameters[paramName]) {
                    html += generateFormField(paramName, parameters[paramName]);
                }
            });
            html += `</div>`;
        }

        html += `</div>`;

        // DHCPä¸­ç»§é…ç½®ç»„
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-exchange-alt me-2"></i>DHCPä¸­ç»§é…ç½®
            </div>`;

        // DHCPä¸­ç»§å¼€å…³
        if (parameters.enable_dhcp_relay) {
            html += generateFormField('enable_dhcp_relay', parameters.enable_dhcp_relay);
        }

        // DHCPä¸­ç»§ç›¸å…³å‚æ•°ï¼ˆä¾èµ–äºenable_dhcp_relayï¼‰
        html += `<div class="conditional-field" data-depends-on="enable_dhcp_relay">`;
        const relayParams = ['relay_server_address', 'relay_interface'];
        relayParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // é«˜çº§é…ç½®ç»„
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-cogs me-2"></i>é«˜çº§é…ç½®
            </div>`;

        // å…¶ä»–å‚æ•°
        const excludeParams = ['enable_dhcp_server', 'dhcp_type', 'pool_name', 'network', 'mask', 'gateway', 'vlanif', 'interface_ip', 'interface_description', 'dns_servers', 'excluded_addresses', 'lease_time', 'enable_dhcp_relay', 'relay_server_address', 'relay_interface', 'enable_interface', 'interface'];
        const sortedParams = Object.entries(parameters)
            .filter(([paramName]) => !excludeParams.includes(paramName))
            .sort(([,a], [,b]) => (a.order || 999) - (b.order || 999));

        sortedParams.forEach(([paramName, param]) => {
            html += generateFormField(paramName, param);
        });

        html += `</div>`;
        return html;
    }

    // ç”ŸæˆVRRPé…ç½®è¡¨å•
    function generateVrrpConfigForm(parameters) {
        let html = '';

        // åŸºç¡€VRRPé…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-shield-alt me-2"></i>åŸºç¡€VRRPé…ç½®
            </div>`;

        // æ ¹æ®å‚å•†æ˜¾ç¤ºä¸åŒçš„ç»„IDå‚æ•°å
        let groupIdParam = 'vrrp_group_id';
        if (currentVendor === 'cisco') {
            groupIdParam = 'hsrp_group_id';
        }

        const basicParams = ['vlan_id', 'interface_ip', groupIdParam, 'virtual_ip', 'priority'];
        basicParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });

        html += `</div>`;

        // é«˜çº§é…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-cogs me-2"></i>é«˜çº§é…ç½®
            </div>`;

        // é«˜çº§é…ç½®å¼€å…³
        if (parameters.configure_advanced) {
            html += generateFormField('configure_advanced', parameters.configure_advanced);
        }

        // é«˜çº§é…ç½®å‚æ•°ï¼ˆä¾èµ–äºconfigure_advancedï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_advanced">`;
        let advancedParams = [];
        if (currentVendor === 'cisco') {
            advancedParams = ['preempt_mode', 'preempt_delay', 'hello_interval', 'hold_time'];
        } else {
            advancedParams = ['preempt_mode', 'preempt_delay', 'advertisement_interval'];
        }
        advancedParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // è®¤è¯é…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-key me-2"></i>è®¤è¯é…ç½®
            </div>`;

        // è®¤è¯é…ç½®å¼€å…³
        if (parameters.configure_authentication) {
            html += generateFormField('configure_authentication', parameters.configure_authentication);
        }

        // è®¤è¯é…ç½®å‚æ•°ï¼ˆä¾èµ–äºconfigure_authenticationï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_authentication">`;
        let authParams = [];
        if (currentVendor === 'h3c') {
            authParams = ['auth_mode', 'auth_key'];
        } else {
            authParams = ['auth_key'];
        }
        authParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // æ¥å£è·Ÿè¸ªé…ç½®ï¼ˆH3Cã€æ€ç§‘ã€é”æ·ï¼‰
        if (currentVendor !== 'huawei') {
            html += `<div class="form-group">
                <div class="form-group-title">
                    <i class="fas fa-search me-2"></i>æ¥å£è·Ÿè¸ªé…ç½®
                </div>`;

            // æ¥å£è·Ÿè¸ªå¼€å…³
            if (parameters.configure_track) {
                html += generateFormField('configure_track', parameters.configure_track);
            }

            // æ¥å£è·Ÿè¸ªå‚æ•°ï¼ˆä¾èµ–äºconfigure_trackï¼‰
            html += `<div class="conditional-field" data-depends-on="configure_track">`;
            const trackParams = ['track_interface', 'track_priority_reduce'];
            trackParams.forEach(paramName => {
                if (parameters[paramName]) {
                    html += generateFormField(paramName, parameters[paramName]);
                }
            });
            html += `</div>`;

            html += `</div>`;
        }

        // åä¸ºç‰¹æœ‰çš„é«˜çº§åŠŸèƒ½
        if (currentVendor === 'huawei') {
            // BFDå¿«é€Ÿåˆ‡æ¢é…ç½®
            html += `<div class="form-group">
                <div class="form-group-title">
                    <i class="fas fa-bolt me-2"></i>BFDå¿«é€Ÿåˆ‡æ¢é…ç½®
                </div>`;

            // BFDå¿«é€Ÿåˆ‡æ¢å¼€å…³
            if (parameters.configure_bfd) {
                html += generateFormField('configure_bfd', parameters.configure_bfd);
            }

            // BFDå¿«é€Ÿåˆ‡æ¢å‚æ•°ï¼ˆä¾èµ–äºconfigure_bfdï¼‰
            html += `<div class="conditional-field" data-depends-on="configure_bfd">`;
            const bfdParams = ['bfd_session_name', 'bfd_peer_ip', 'bfd_local_discriminator', 'bfd_remote_discriminator', 'bfd_priority_reduce'];
            bfdParams.forEach(paramName => {
                if (parameters[paramName]) {
                    html += generateFormField(paramName, parameters[paramName]);
                }
            });
            html += `</div>`;

            html += `</div>`;

            // åŠ¨æ€BFDé…ç½®
            html += `<div class="form-group">
                <div class="form-group-title">
                    <i class="fas fa-sync-alt me-2"></i>åŠ¨æ€BFDé…ç½®
                </div>`;

            // åŠ¨æ€BFDå¼€å…³
            if (parameters.configure_dynamic_bfd) {
                html += generateFormField('configure_dynamic_bfd', parameters.configure_dynamic_bfd);
            }

            // åŠ¨æ€BFDå‚æ•°ï¼ˆä¾èµ–äºconfigure_dynamic_bfdï¼‰
            html += `<div class="conditional-field" data-depends-on="configure_dynamic_bfd">`;
            const dynamicBfdParams = ['dynamic_bfd_template'];
            dynamicBfdParams.forEach(paramName => {
                if (parameters[paramName]) {
                    html += generateFormField(paramName, parameters[paramName]);
                }
            });
            html += `</div>`;

            html += `</div>`;

            // æ¥å£ç›‘è§†é…ç½®
            html += `<div class="form-group">
                <div class="form-group-title">
                    <i class="fas fa-eye me-2"></i>æ¥å£ç›‘è§†é…ç½®
                </div>`;

            // æ¥å£ç›‘è§†å¼€å…³
            if (parameters.configure_interface_monitor) {
                html += generateFormField('configure_interface_monitor', parameters.configure_interface_monitor);
            }

            // æ¥å£ç›‘è§†å‚æ•°ï¼ˆä¾èµ–äºconfigure_interface_monitorï¼‰
            html += `<div class="conditional-field" data-depends-on="configure_interface_monitor">`;
            const interfaceMonitorParams = ['monitor_interface', 'monitor_priority_reduce'];
            interfaceMonitorParams.forEach(paramName => {
                if (parameters[paramName]) {
                    html += generateFormField(paramName, parameters[paramName]);
                }
            });
            html += `</div>`;

            html += `</div>`;

            // BFDä¸Šè¡Œé“¾è·¯ç›‘è§†é…ç½®
            html += `<div class="form-group">
                <div class="form-group-title">
                    <i class="fas fa-link me-2"></i>BFDä¸Šè¡Œé“¾è·¯ç›‘è§†é…ç½®
                </div>`;

            // BFDä¸Šè¡Œé“¾è·¯ç›‘è§†å¼€å…³
            if (parameters.configure_bfd_uplink) {
                html += generateFormField('configure_bfd_uplink', parameters.configure_bfd_uplink);
            }

            // BFDä¸Šè¡Œé“¾è·¯ç›‘è§†å‚æ•°ï¼ˆä¾èµ–äºconfigure_bfd_uplinkï¼‰
            html += `<div class="conditional-field" data-depends-on="configure_bfd_uplink">`;
            const bfdUplinkParams = ['bfd_uplink_session_name', 'bfd_uplink_peer_ip', 'bfd_uplink_local_discriminator', 'bfd_uplink_remote_discriminator', 'bfd_uplink_priority_reduce'];
            bfdUplinkParams.forEach(paramName => {
                if (parameters[paramName]) {
                    html += generateFormField(paramName, parameters[paramName]);
                }
            });
            html += `</div>`;

            html += `</div>`;

            // NQAä¸Šè¡Œé“¾è·¯ç›‘è§†é…ç½®
            html += `<div class="form-group">
                <div class="form-group-title">
                    <i class="fas fa-satellite-dish me-2"></i>NQAä¸Šè¡Œé“¾è·¯ç›‘è§†é…ç½®
                </div>`;

            // NQAä¸Šè¡Œé“¾è·¯ç›‘è§†å¼€å…³
            if (parameters.configure_nqa_uplink) {
                html += generateFormField('configure_nqa_uplink', parameters.configure_nqa_uplink);
            }

            // NQAä¸Šè¡Œé“¾è·¯ç›‘è§†å‚æ•°ï¼ˆä¾èµ–äºconfigure_nqa_uplinkï¼‰
            html += `<div class="conditional-field" data-depends-on="configure_nqa_uplink">`;
            const nqaUplinkParams = ['nqa_test_instance', 'nqa_destination_ip', 'nqa_priority_reduce'];
            nqaUplinkParams.forEach(paramName => {
                if (parameters[paramName]) {
                    html += generateFormField(paramName, parameters[paramName]);
                }
            });
            html += `</div>`;

            html += `</div>`;

            // è·¯ç”±ç›‘è§†é…ç½®
            html += `<div class="form-group">
                <div class="form-group-title">
                    <i class="fas fa-route me-2"></i>è·¯ç”±ç›‘è§†é…ç½®
                </div>`;

            // è·¯ç”±ç›‘è§†å¼€å…³
            if (parameters.configure_route_monitor) {
                html += generateFormField('configure_route_monitor', parameters.configure_route_monitor);
            }

            // è·¯ç”±ç›‘è§†å‚æ•°ï¼ˆä¾èµ–äºconfigure_route_monitorï¼‰
            html += `<div class="conditional-field" data-depends-on="configure_route_monitor">`;
            const routeMonitorParams = ['monitor_route', 'route_priority_reduce'];
            routeMonitorParams.forEach(paramName => {
                if (parameters[paramName]) {
                    html += generateFormField(paramName, parameters[paramName]);
                }
            });
            html += `</div>`;

            html += `</div>`;
        }

        // å…¶ä»–å‚æ•°
        let excludeParams = [...basicParams];

        // æ·»åŠ é«˜çº§é…ç½®å‚æ•°
        if (currentVendor === 'cisco') {
            excludeParams.push(...['preempt_mode', 'preempt_delay', 'hello_interval', 'hold_time']);
        } else {
            excludeParams.push(...['preempt_mode', 'preempt_delay', 'advertisement_interval']);
        }

        // æ·»åŠ è®¤è¯é…ç½®å‚æ•°
        if (currentVendor === 'h3c') {
            excludeParams.push(...['auth_mode', 'auth_key']);
        } else {
            excludeParams.push('auth_key');
        }

        // æ·»åŠ å¼€å…³å‚æ•°
        excludeParams.push('configure_advanced', 'configure_authentication');

        // æ·»åŠ æ¥å£è·Ÿè¸ªå‚æ•°ï¼ˆéåä¸ºå‚å•†ï¼‰
        if (currentVendor !== 'huawei') {
            excludeParams.push('configure_track', 'track_interface', 'track_priority_reduce');
        }

        // æ·»åŠ åä¸ºç‰¹æœ‰çš„å‚æ•°
        if (currentVendor === 'huawei') {
            excludeParams.push(
                'configure_bfd', 'bfd_session_name', 'bfd_peer_ip', 'bfd_local_discriminator', 'bfd_remote_discriminator', 'bfd_priority_reduce',
                'configure_dynamic_bfd', 'dynamic_bfd_template',
                'configure_interface_monitor', 'monitor_interface', 'monitor_priority_reduce',
                'configure_bfd_uplink', 'bfd_uplink_session_name', 'bfd_uplink_peer_ip', 'bfd_uplink_local_discriminator', 'bfd_uplink_remote_discriminator', 'bfd_uplink_priority_reduce',
                'configure_nqa_uplink', 'nqa_test_instance', 'nqa_destination_ip', 'nqa_priority_reduce',
                'configure_route_monitor', 'monitor_route', 'route_priority_reduce'
            );
        }

        // æ·»åŠ å‚å•†ç‰¹å®šçš„ç»„IDå‚æ•°
        excludeParams.push('vrrp_group_id', 'hsrp_group_id');
        const sortedParams = Object.entries(parameters)
            .filter(([paramName]) => !excludeParams.includes(paramName))
            .sort(([,a], [,b]) => (a.order || 999) - (b.order || 999));

        if (sortedParams.length > 0) {
            html += `<div class="form-group">
                <div class="form-group-title">
                    <i class="fas fa-sliders-h me-2"></i>å…¶ä»–é…ç½®
                </div>`;

            sortedParams.forEach(([paramName, param]) => {
                html += generateFormField(paramName, param);
            });

            html += `</div>`;
        }

        return html;
    }

    // ç”Ÿæˆç«¯å£èšåˆé…ç½®è¡¨å•
    function generatePortAggregationForm(parameters) {
        let html = '';

        // åŸºç¡€èšåˆé…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-link me-2"></i>åŸºç¡€èšåˆé…ç½®
            </div>`;

        const basicParams = ['mode', 'lag_id', 'description', 'interfaces'];
        basicParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });

        html += `</div>`;

        // è´Ÿè½½å‡è¡¡é…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-balance-scale me-2"></i>è´Ÿè½½å‡è¡¡é…ç½®
            </div>`;

        // è´Ÿè½½å‡è¡¡å¼€å…³
        if (parameters.configure_load_balance) {
            html += generateFormField('configure_load_balance', parameters.configure_load_balance);
        }

        // è´Ÿè½½å‡è¡¡å‚æ•°ï¼ˆä¾èµ–äºconfigure_load_balanceï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_load_balance">`;
        const loadBalanceParams = ['load_balance_mode'];
        loadBalanceParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // LACPé…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-cogs me-2"></i>LACPé…ç½®
            </div>`;

        // LACPä¼˜å…ˆçº§å¼€å…³
        if (parameters.configure_lacp_priority) {
            html += generateFormField('configure_lacp_priority', parameters.configure_lacp_priority);
        }

        // LACPä¼˜å…ˆçº§å‚æ•°ï¼ˆä¾èµ–äºconfigure_lacp_priorityï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_lacp_priority">`;
        const lacpPriorityParams = ['lacp_system_priority', 'lacp_port_priority'];
        lacpPriorityParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        // LACPè¶…æ—¶å¼€å…³
        if (parameters.configure_lacp_timeout) {
            html += generateFormField('configure_lacp_timeout', parameters.configure_lacp_timeout);
        }

        // LACPè¶…æ—¶å‚æ•°ï¼ˆä¾èµ–äºconfigure_lacp_timeoutï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_lacp_timeout">`;
        const lacpTimeoutParams = ['lacp_timeout'];
        lacpTimeoutParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // é«˜çº§é…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-sliders-h me-2"></i>é«˜çº§é…ç½®
            </div>`;

        // é«˜çº§é…ç½®å¼€å…³
        if (parameters.configure_advanced) {
            html += generateFormField('configure_advanced', parameters.configure_advanced);
        }

        // é«˜çº§é…ç½®å‚æ•°ï¼ˆä¾èµ–äºconfigure_advancedï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_advanced">`;
        const advancedParams = ['min_active_links', 'local_preference'];
        advancedParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // å…¶ä»–å‚æ•°
        const excludeParams = [...basicParams, ...loadBalanceParams, ...lacpPriorityParams, ...lacpTimeoutParams, ...advancedParams, 'configure_load_balance', 'configure_lacp_priority', 'configure_lacp_timeout', 'configure_advanced'];
        const sortedParams = Object.entries(parameters)
            .filter(([paramName]) => !excludeParams.includes(paramName))
            .sort(([,a], [,b]) => (a.order || 999) - (b.order || 999));

        if (sortedParams.length > 0) {
            html += `<div class="form-group">
                <div class="form-group-title">
                    <i class="fas fa-ellipsis-h me-2"></i>å…¶ä»–é…ç½®
                </div>`;

            sortedParams.forEach(([paramName, param]) => {
                html += generateFormField(paramName, param);
            });

            html += `</div>`;
        }

        return html;
    }

    // ç”ŸæˆSTPé…ç½®è¡¨å•
    function generateStpConfigForm(parameters) {
        let html = '';

        // åŸºç¡€STPé…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-tree me-2"></i>åŸºç¡€STPé…ç½®
            </div>`;

        const basicParams = ['stp_mode'];
        basicParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });

        // å…¨å±€å¯ç”¨å¼€å…³
        if (parameters.global_enable) {
            html += generateFormField('global_enable', parameters.global_enable);
        }

        // BPDUä¿æŠ¤å¼€å…³
        if (parameters.bpdu_protection) {
            html += generateFormField('bpdu_protection', parameters.bpdu_protection);
        }

        // æ ¹æ¡¥é…ç½®å’Œæ¡¥ä¼˜å…ˆçº§
        const rootParams = ['root_bridge_config', 'bridge_priority'];
        rootParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });

        html += `</div>`;

        // MSTPé…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-sitemap me-2"></i>MSTPé…ç½®
            </div>`;

        const mstpParams = ['region_name', 'revision_level', 'instance_vlan_mapping', 'instance_id'];
        mstpParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });

        html += `</div>`;

        // æ—¶é—´å‚æ•°é…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-clock me-2"></i>æ—¶é—´å‚æ•°é…ç½®
            </div>`;

        // æ—¶é—´å‚æ•°å¼€å…³
        if (parameters.configure_timing_params) {
            html += generateFormField('configure_timing_params', parameters.configure_timing_params);
        }

        // æ—¶é—´å‚æ•°ï¼ˆä¾èµ–äºconfigure_timing_paramsï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_timing_params">`;
        const timingParams = ['hello_time', 'forward_delay', 'max_age'];
        timingParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // ç«¯å£é…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-ethernet me-2"></i>ç«¯å£é…ç½®
            </div>`;

        // ç«¯å£é…ç½®å¼€å…³
        if (parameters.configure_port_blocking) {
            html += generateFormField('configure_port_blocking', parameters.configure_port_blocking);
        }

        // ç«¯å£é…ç½®å‚æ•°ï¼ˆä¾èµ–äºconfigure_port_blockingï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_port_blocking">`;
        const portParams = ['interface', 'port_cost', 'edge_port', 'edge_port_interface', 'root_protection', 'root_protection_interface', 'loop_protection', 'loop_protection_interface'];
        portParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // å…¶ä»–å‚æ•°
        const excludeParams = [...basicParams, ...rootParams, ...mstpParams, ...timingParams, ...portParams, 'global_enable', 'bpdu_protection', 'configure_timing_params', 'configure_port_blocking'];
        const sortedParams = Object.entries(parameters)
            .filter(([paramName]) => !excludeParams.includes(paramName))
            .sort(([,a], [,b]) => (a.order || 999) - (b.order || 999));

        if (sortedParams.length > 0) {
            html += `<div class="form-group">
                <div class="form-group-title">
                    <i class="fas fa-ellipsis-h me-2"></i>å…¶ä»–é…ç½®
                </div>`;

            sortedParams.forEach(([paramName, param]) => {
                html += generateFormField(paramName, param);
            });

            html += `</div>`;
        }

        return html;
    }

    // ç”ŸæˆOSPFé…ç½®è¡¨å•
    function generateOspfConfigForm(parameters) {
        let html = '';

        // åŸºç¡€OSPFé…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-route me-2"></i>åŸºç¡€OSPFé…ç½®
            </div>`;

        // åŸºç¡€é…ç½®å¼€å…³ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (parameters.enable_basic_config) {
            html += generateFormField('enable_basic_config', parameters.enable_basic_config);
        }

        // åŸºç¡€é…ç½®å‚æ•°ï¼ˆä¾èµ–äºenable_basic_configï¼‰
        html += `<div class="conditional-field" data-depends-on="enable_basic_config">`;
        const basicParams = ['process_id', 'router_id', 'areas'];
        basicParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // åŒºåŸŸè®¤è¯é…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-key me-2"></i>åŒºåŸŸè®¤è¯é…ç½®
            </div>`;

        // åŒºåŸŸè®¤è¯å¼€å…³
        if (parameters.configure_area_auth) {
            html += generateFormField('configure_area_auth', parameters.configure_area_auth);
        }

        // åŒºåŸŸè®¤è¯å‚æ•°ï¼ˆä¾èµ–äºconfigure_area_authï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_area_auth">`;
        const areaAuthParams = ['area_auth_type', 'area_auth_area', 'area_auth_password'];
        areaAuthParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // æ¥å£è®¤è¯é…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-shield-alt me-2"></i>æ¥å£è®¤è¯é…ç½®
            </div>`;

        // æ¥å£è®¤è¯å¼€å…³
        if (parameters.configure_interface_auth) {
            html += generateFormField('configure_interface_auth', parameters.configure_interface_auth);
        }

        // æ¥å£è®¤è¯å‚æ•°ï¼ˆä¾èµ–äºconfigure_interface_authï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_interface_auth">`;
        const interfaceAuthParams = ['interface_auth_interface', 'interface_auth_type', 'interface_auth_password'];
        interfaceAuthParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // æ¥å£é…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-ethernet me-2"></i>æ¥å£é…ç½®
            </div>`;

        // æ¥å£é…ç½®å¼€å…³
        if (parameters.configure_interface) {
            html += generateFormField('configure_interface', parameters.configure_interface);
        }

        // æ¥å£é…ç½®å‚æ•°ï¼ˆä¾èµ–äºconfigure_interfaceï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_interface">`;
        const interfaceParams = ['interface_name', 'configure_interface_routing', 'interface_cost', 'interface_priority'];
        interfaceParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // å®šæ—¶å™¨é…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-clock me-2"></i>å®šæ—¶å™¨é…ç½®
            </div>`;

        // å®šæ—¶å™¨é…ç½®å¼€å…³
        if (parameters.configure_timers) {
            html += generateFormField('configure_timers', parameters.configure_timers);
        }

        // å®šæ—¶å™¨é…ç½®å‚æ•°ï¼ˆä¾èµ–äºconfigure_timersï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_timers">`;
        const timerParams = ['hello_interval', 'dead_interval'];
        timerParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // è·¯ç”±å¼•å…¥é…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-share-alt me-2"></i>è·¯ç”±å¼•å…¥é…ç½®
            </div>`;

        // è·¯ç”±å¼•å…¥é…ç½®å¼€å…³
        if (parameters.configure_redistribute) {
            html += generateFormField('configure_redistribute', parameters.configure_redistribute);
        }

        // è·¯ç”±å¼•å…¥é…ç½®å‚æ•°ï¼ˆä¾èµ–äºconfigure_redistributeï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_redistribute">`;
        const redistributeParams = ['redistribute_static', 'redistribute_direct', 'redistribute_rip', 'redistribute_bgp', 'redistribute_isis', 'redistribute_cost', 'redistribute_type'];
        redistributeParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // é«˜çº§é…ç½®
        html += `<div class="form-group">
            <div class="form-group-title">
                <i class="fas fa-cogs me-2"></i>é«˜çº§é…ç½®
            </div>`;

        // é«˜çº§é…ç½®å¼€å…³
        if (parameters.configure_advanced) {
            html += generateFormField('configure_advanced', parameters.configure_advanced);
        }

        // é«˜çº§é…ç½®å‚æ•°ï¼ˆä¾èµ–äºconfigure_advancedï¼‰
        html += `<div class="conditional-field" data-depends-on="configure_advanced">`;
        const advancedParams = ['stub_area', 'nssa_area', 'area_range'];
        advancedParams.forEach(paramName => {
            if (parameters[paramName]) {
                html += generateFormField(paramName, parameters[paramName]);
            }
        });
        html += `</div>`;

        html += `</div>`;

        // å…¶ä»–å‚æ•°
        const excludeParams = [
            ...basicParams, ...areaAuthParams, ...interfaceAuthParams, ...interfaceParams,
            ...timerParams, ...redistributeParams, ...advancedParams,
            'enable_basic_config', 'configure_area_auth', 'configure_interface_auth',
            'configure_interface', 'configure_timers', 'configure_redistribute', 'configure_advanced'
        ];
        const sortedParams = Object.entries(parameters)
            .filter(([paramName]) => !excludeParams.includes(paramName))
            .sort(([,a], [,b]) => (a.order || 999) - (b.order || 999));

        if (sortedParams.length > 0) {
            html += `<div class="form-group">
                <div class="form-group-title">
                    <i class="fas fa-ellipsis-h me-2"></i>å…¶ä»–é…ç½®
                </div>`;

            sortedParams.forEach(([paramName, param]) => {
                html += generateFormField(paramName, param);
            });

            html += `</div>`;
        }

        return html;
    }

    // ç”Ÿæˆé€šç”¨è¡¨å•
    function generateGenericForm(parameters) {
        let html = `<div class="form-group">`;

        const sortedParams = Object.entries(parameters)
            .sort(([,a], [,b]) => (a.order || 999) - (b.order || 999));

        sortedParams.forEach(([paramName, param]) => {
            html += generateFormField(paramName, param);
        });

        html += `</div>`;
        return html;
    }

    // ç”Ÿæˆè¡¨å•å­—æ®µ - æ”¯æŒå¼€å…³æ§åˆ¶å’Œç«¯å£è¾“å…¥
    function generateFormField(paramName, param) {
        const fieldId = `${paramName}_${Math.random().toString(36).substr(2, 9)}`;
        let html = '';

        // å¤„ç†æ•°ç»„ç±»å‹å‚æ•°ï¼ˆåŠ¨æ€è¡¨å•ï¼‰
        if (param.type === 'array') {
            return generateArrayFormField(paramName, param);
        }

        // æ™®é€šå­—æ®µåŒ…è£…
        html += `<div class="mb-3">`;

        // ç”ŸæˆåŠ¨æ€æ ‡ç­¾
        const dynamicLabel = getDynamicFieldLabel(paramName, param);
        html += `<label class="form-label" for="${fieldId}" id="label_${paramName}">
            ${dynamicLabel}
            ${param.required ? '<span class="text-danger">*</span>' : ''}
        </label>`;

        // æ ¹æ®å‚æ•°ç±»å‹ç”Ÿæˆä¸åŒçš„è¾“å…¥æ§ä»¶
        if (param.type === 'boolean') {
            // å¼€å…³æ§ä»¶
            html += `<div class="d-flex align-items-center gap-3">
                <label class="toggle-switch">
                    <input type="checkbox" id="${fieldId}" name="${paramName}"
                        ${param.default ? 'checked' : ''}
                        onchange="handleToggleChange('${paramName}', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label">${param.default ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}</span>
            </div>`;
        } else if (isInterfaceField(paramName)) {
            // ç«¯å£è¾“å…¥ç»„åˆæ§ä»¶
            html += generatePortInputField(fieldId, paramName, param);
        } else if (param.options && param.options.length > 0) {
            // ä¸‹æ‹‰é€‰æ‹©
            let changeHandler = '';
            if (paramName === 'port_mode') {
                changeHandler = `onchange="handlePortModeChange(this.value)"`;
            } else if (paramName === 'dhcp_type') {
                changeHandler = `onchange="handleSelectChange('${paramName}', this.value)"`;
            }

            html += `<select class="form-control" id="${fieldId}" name="${paramName}" ${changeHandler}>`;
            html += `<option value="">è¯·é€‰æ‹©...</option>`;
            param.options.forEach(option => {
                const selected = param.default === option ? 'selected' : '';
                html += `<option value="${option}" ${selected}>${option}</option>`;
            });
            html += `</select>`;
        } else if (param.type === 'integer') {
            // æ•°å­—è¾“å…¥
            html += `<input type="number" class="form-control"
                id="${fieldId}" name="${paramName}"
                placeholder="${param.placeholder || ''}"
                value="${param.default || ''}"
                ${param.range ? `min="${param.range[0]}" max="${param.range[1]}"` : ''}
                ${param.required ? 'required' : ''}>`;
        } else if (param.max_length && param.max_length > 100) {
            // æ–‡æœ¬åŸŸ
            html += `<textarea class="form-control" id="${fieldId}" name="${paramName}"
                placeholder="${param.placeholder || ''}" rows="3"
                ${param.max_length ? `maxlength="${param.max_length}"` : ''}
                ${param.required ? 'required' : ''}>${param.default || ''}</textarea>`;
        } else {
            // æ™®é€šæ–‡æœ¬è¾“å…¥
            html += `<input type="text" class="form-control"
                id="${fieldId}" name="${paramName}"
                placeholder="${param.placeholder || ''}"
                value="${param.default || ''}"
                ${param.max_length ? `maxlength="${param.max_length}"` : ''}
                ${param.required ? 'required' : ''}>`;
        }

        // æ·»åŠ å¸®åŠ©æ–‡æœ¬
        if (param.help || param.placeholder) {
            html += `<small class="form-text text-muted">${param.help || param.placeholder}</small>`;
        }

        html += '</div>';
        return html;
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯æ¥å£å­—æ®µ
    function isInterfaceField(paramName) {
        // æ˜ç¡®çš„æ¥å£åç§°å­—æ®µ
        const interfaceFields = ['interface', 'interfaces', 'member_interfaces', 'trunk_interfaces', 'interface_name'];

        // æ’é™¤ä¸æ˜¯æ¥å£åç§°çš„å­—æ®µï¼ˆå³ä½¿åŒ…å«interfaceæˆ–portå…³é”®è¯ï¼‰
        const excludeFields = [
            'port_mode', 'port_type', 'port_status', 'port_speed', 'port_duplex',
            'interface_description', 'interface_mode', 'interface_type', 'interface_status', 'interface_speed',
            // OSPFæ¥å£è®¤è¯å’Œé…ç½®ç›¸å…³å­—æ®µ
            'interface_auth_password', 'interface_auth_type', 'interface_cost', 'interface_priority',
            // å…¶ä»–æ¥å£å±æ€§å­—æ®µ
            'interface_ip', 'interface_netmask', 'interface_gateway'
        ];

        // å¦‚æœåœ¨æ’é™¤åˆ—è¡¨ä¸­ï¼Œç›´æ¥è¿”å›false
        if (excludeFields.includes(paramName)) {
            return false;
        }

        // å¦‚æœåœ¨æ˜ç¡®çš„æ¥å£å­—æ®µåˆ—è¡¨ä¸­ï¼Œè¿”å›true
        if (interfaceFields.includes(paramName)) {
            return true;
        }

        // å¯¹äºåŒ…å«interfaceçš„å­—æ®µï¼Œåªæœ‰å½“å®ƒæ˜ç¡®è¡¨ç¤ºæ¥å£åç§°æ—¶æ‰è¿”å›true
        if (paramName.includes('interface')) {
            // åªæœ‰è¿™äº›æ¨¡å¼æ‰è¢«è®¤ä¸ºæ˜¯æ¥å£åç§°å­—æ®µ
            const interfaceNamePatterns = [
                /^interface$/,
                /^.*_interface$/,
                /^interface_.*$/
            ];

            // ä½†æ’é™¤æ˜æ˜¾ä¸æ˜¯æ¥å£åç§°çš„å­—æ®µï¼ˆä½†ä¿ç•™interface_nameä½œä¸ºæ¥å£å­—æ®µï¼‰
            const nonInterfacePatterns = [
                /_description$/,
                /_mode$/,
                /_type$/,
                /_status$/,
                /_speed$/,
                /_ip$/,
                /_address$/,
                /_password$/,
                /_cost$/,
                /_priority$/
            ];

            // æ£€æŸ¥æ˜¯å¦åŒ¹é…éæ¥å£åç§°æ¨¡å¼
            if (nonInterfacePatterns.some(pattern => pattern.test(paramName))) {
                return false;
            }

            // æ£€æŸ¥æ˜¯å¦åŒ¹é…æ¥å£åç§°æ¨¡å¼
            return interfaceNamePatterns.some(pattern => pattern.test(paramName));
        }

        // å¯¹äºportå­—æ®µï¼Œåªæœ‰portå’Œportsè¢«è®¤ä¸ºæ˜¯æ¥å£å­—æ®µ
        return paramName === 'port' || paramName === 'ports';
    }

    // ç”Ÿæˆç«¯å£è¾“å…¥å­—æ®µï¼ˆåˆ é™¤äº†é¢„è§ˆåŠŸèƒ½ï¼‰
    function generatePortInputField(fieldId, paramName, param) {
        const prefixSelectId = `${fieldId}_prefix`;
        const numberInputId = `${fieldId}_number`;

        // æ ¹æ®å½“å‰å‚å•†è·å–æ¥å£å‰ç¼€é€‰é¡¹
        const interfacePrefixes = getInterfacePrefixes(currentVendor);

        let html = `<div class="port-input-group" data-param="${paramName}">
            <div class="row">
                <div class="col-md-6">
                    <select class="form-control port-prefix-select" id="${prefixSelectId}"
                        onchange="updatePortCombination('${paramName}')">
                        <option value="">é€‰æ‹©æ¥å£ç±»å‹...</option>`;

        interfacePrefixes.forEach(prefix => {
            html += `<option value="${prefix.value}">${prefix.label}</option>`;
        });

        html += `</select>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control port-number-input" id="${numberInputId}"
                        placeholder="ç«¯å£ç¼–å· (å¦‚: 0/0/1,0/0/4,0/0/9-12)"
                        oninput="updatePortCombination('${paramName}')"
                        ${param.required ? 'required' : ''}>
                </div>
            </div>
            <input type="hidden" id="${fieldId}" name="${paramName}">
        </div>`;

        return html;
    }

    // è·å–æ¥å£å‰ç¼€é€‰é¡¹
    function getInterfacePrefixes(vendor) {
        const prefixLabels = {
            'huawei': [
                { value: 'GigabitEthernet', label: 'GigabitEthernet (åƒå…†ä»¥å¤ªç½‘)' },
                { value: 'XGigabitEthernet', label: 'XGigabitEthernet (ä¸‡å…†ä»¥å¤ªç½‘)' },
                { value: '10GE', label: '10GE (ä¸‡å…†ä»¥å¤ªç½‘ç®€å†™)' },
                { value: '25GE', label: '25GE (25Gä»¥å¤ªç½‘)' },
                { value: '40GE', label: '40GE (40Gä»¥å¤ªç½‘)' },
                { value: '100GE', label: '100GE (ç™¾Gä»¥å¤ªç½‘)' },
                { value: 'Vlanif', label: 'Vlanif (VLANæ¥å£)' },
                { value: 'Eth-Trunk', label: 'Eth-Trunk (èšåˆæ¥å£)' },
                { value: 'LoopBack', label: 'LoopBack (ç¯å›æ¥å£)' }
            ],
            'h3c': [
                { value: 'Ethernet', label: 'Ethernet (ä»¥å¤ªç½‘)' },
                { value: 'GigabitEthernet', label: 'GigabitEthernet (åƒå…†ä»¥å¤ªç½‘)' },
                { value: 'Ten-GigabitEthernet', label: 'Ten-GigabitEthernet (ä¸‡å…†ä»¥å¤ªç½‘)' },
                { value: 'Twenty-FiveGigE', label: 'Twenty-FiveGigE (25Gä»¥å¤ªç½‘)' },
                { value: 'FortyGigE', label: 'FortyGigE (40Gä»¥å¤ªç½‘)' },
                { value: 'HundredGigE', label: 'HundredGigE (ç™¾Gä»¥å¤ªç½‘)' },
                { value: 'Vlan-interface', label: 'Vlan-interface (VLANæ¥å£)' },
                { value: 'Bridge-Aggregation', label: 'Bridge-Aggregation (èšåˆæ¥å£)' },
                { value: 'LoopBack', label: 'LoopBack (ç¯å›æ¥å£)' }
            ],
            'cisco': [
                { value: 'FastEthernet', label: 'FastEthernet (å¿«é€Ÿä»¥å¤ªç½‘)' },
                { value: 'GigabitEthernet', label: 'GigabitEthernet (åƒå…†ä»¥å¤ªç½‘)' },
                { value: 'TenGigabitEthernet', label: 'TenGigabitEthernet (ä¸‡å…†ä»¥å¤ªç½‘)' },
                { value: 'TwentyFiveGigE', label: 'TwentyFiveGigE (25Gä»¥å¤ªç½‘)' },
                { value: 'FortyGigabitEthernet', label: 'FortyGigabitEthernet (40Gä»¥å¤ªç½‘)' },
                { value: 'HundredGigE', label: 'HundredGigE (ç™¾Gä»¥å¤ªç½‘)' },
                { value: 'Vlan', label: 'Vlan (VLANæ¥å£)' },
                { value: 'Port-channel', label: 'Port-channel (èšåˆæ¥å£)' },
                { value: 'Loopback', label: 'Loopback (ç¯å›æ¥å£)' }
            ],
            'ruijie': [
                { value: 'FastEthernet', label: 'FastEthernet (å¿«é€Ÿä»¥å¤ªç½‘)' },
                { value: 'GigabitEthernet', label: 'GigabitEthernet (åƒå…†ä»¥å¤ªç½‘)' },
                { value: 'TenGigabitEthernet', label: 'TenGigabitEthernet (ä¸‡å…†ä»¥å¤ªç½‘)' },
                { value: 'TwentyFiveGigE', label: 'TwentyFiveGigE (25Gä»¥å¤ªç½‘)' },
                { value: 'FortyGigabitEthernet', label: 'FortyGigabitEthernet (40Gä»¥å¤ªç½‘)' },
                { value: 'HundredGigE', label: 'HundredGigE (ç™¾Gä»¥å¤ªç½‘)' },
                { value: 'Vlan', label: 'Vlan (VLANæ¥å£)' },
                { value: 'AggregatePort', label: 'AggregatePort (èšåˆæ¥å£)' },
                { value: 'Loopback', label: 'Loopback (ç¯å›æ¥å£)' }
            ]
        };

        return prefixLabels[vendor] || prefixLabels['huawei'];
    }

    // æ›´æ–°æ‰€æœ‰ç«¯å£è¾“å…¥å­—æ®µçš„æ¥å£å‰ç¼€é€‰é¡¹
    function updateAllPortPrefixes() {
        const portInputGroups = document.querySelectorAll('.port-input-group');
        const interfacePrefixes = getInterfacePrefixes(currentVendor);

        portInputGroups.forEach(group => {
            const prefixSelect = group.querySelector('.port-prefix-select');
            if (prefixSelect) {
                const currentValue = prefixSelect.value;

                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                prefixSelect.innerHTML = '<option value="">é€‰æ‹©æ¥å£ç±»å‹...</option>';

                // æ·»åŠ æ–°çš„å‚å•†ç‰¹å®šé€‰é¡¹
                interfacePrefixes.forEach(prefix => {
                    const option = document.createElement('option');
                    option.value = prefix.value;
                    option.textContent = prefix.label;
                    if (prefix.value === currentValue) {
                        option.selected = true;
                    }
                    prefixSelect.appendChild(option);
                });

                // å¦‚æœå½“å‰å€¼åœ¨æ–°å‚å•†ä¸­ä¸å­˜åœ¨ï¼Œæ¸…ç©ºé€‰æ‹©å¹¶æ›´æ–°ç»„åˆ
                if (currentValue && !interfacePrefixes.some(p => p.value === currentValue)) {
                    prefixSelect.value = '';
                    const paramName = group.getAttribute('data-param');
                    if (paramName) {
                        updatePortCombination(paramName);
                    }
                }
            }
        });
    }

    // æ›´æ–°å‚å•†æŒ‰é’®çŠ¶æ€
    function updateVendorButtonsState() {
        const vendorButtons = document.querySelectorAll('.vendor-btn');
        vendorButtons.forEach(btn => {
            if (currentStep === 1) {
                btn.classList.remove('disabled');
            } else {
                btn.classList.add('disabled');
            }
        });
    }

    // è·å–åŠ¨æ€å­—æ®µæ ‡ç­¾
    function getDynamicFieldLabel(paramName, param) {
        const originalLabel = param.description || paramName;

        // ç‰¹æ®Šå¤„ç†PVIDå­—æ®µ
        if (paramName === 'pvid') {
            // è·å–å½“å‰é€‰æ‹©çš„ç«¯å£æ¨¡å¼
            const portModeSelect = document.querySelector('select[name="port_mode"]');
            const currentPortMode = portModeSelect ? portModeSelect.value : '';

            if (currentPortMode === 'access') {
                // accessæ¨¡å¼ä¸‹çš„æ ‡ç­¾
                if (currentVendor === 'huawei' || currentVendor === 'h3c') {
                    return 'Default VLAN';
                } else if (currentVendor === 'cisco' || currentVendor === 'ruijie') {
                    return 'VLAN ID';
                }
            } else if (currentPortMode === 'trunk') {
                // trunkæ¨¡å¼ä¸‹çš„æ ‡ç­¾
                if (currentVendor === 'huawei' || currentVendor === 'h3c') {
                    return 'PVID';
                } else if (currentVendor === 'cisco' || currentVendor === 'ruijie') {
                    return 'Native VLAN';
                }
            } else {
                // æœªé€‰æ‹©æ¨¡å¼æ—¶çš„é»˜è®¤æ ‡ç­¾
                return 'ç«¯å£PVID';
            }
        }

        return originalLabel;
    }

    // æ›´æ–°å­—æ®µæ ‡ç­¾ï¼ˆå½“å‚å•†æˆ–ç«¯å£æ¨¡å¼æ”¹å˜æ—¶è°ƒç”¨ï¼‰
    function updateFieldLabels() {
        // æ›´æ–°PVIDå­—æ®µæ ‡ç­¾
        const pvidLabel = document.getElementById('label_pvid');
        if (pvidLabel) {
            const newLabel = getDynamicFieldLabel('pvid', { description: 'ç«¯å£PVID' });
            pvidLabel.innerHTML = newLabel + (pvidLabel.innerHTML.includes('text-danger') ? ' <span class="text-danger">*</span>' : '');
        }
    }

    // æ£€æŸ¥é…ç½®æ˜¯å¦æœ‰æ•ˆ
    function checkValidConfiguration(formData) {
        console.log('æ£€æŸ¥é…ç½®æœ‰æ•ˆæ€§:', formData);

        // å¦‚æœæ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œè‚¯å®šæ— æ•ˆ
        if (!formData || Object.keys(formData).length === 0) {
            console.log('æ— é…ç½®æ•°æ®');
            return false;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å¯ç”¨çš„å¸ƒå°”å¼€å…³
        const enabledSwitches = Object.entries(formData).filter(([key, value]) => {
            return typeof value === 'boolean' && value === true;
        });

        console.log('å¯ç”¨çš„å¼€å…³:', enabledSwitches);

        // å¦‚æœæœ‰å¯ç”¨çš„å¼€å…³ï¼Œè®¤ä¸ºé…ç½®æœ‰æ•ˆ
        if (enabledSwitches.length > 0) {
            return true;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰éç©ºçš„å­—ç¬¦ä¸²å€¼ï¼ˆå¯èƒ½æ˜¯ç›´æ¥å¡«å†™çš„é…ç½®ï¼‰
        const nonEmptyValues = Object.entries(formData).filter(([key, value]) => {
            return typeof value === 'string' && value.trim() !== '';
        });

        console.log('éç©ºå­—ç¬¦ä¸²å€¼:', nonEmptyValues);

        // å¦‚æœæœ‰éç©ºå€¼ï¼Œä¹Ÿè®¤ä¸ºé…ç½®æœ‰æ•ˆ
        if (nonEmptyValues.length > 0) {
            return true;
        }

        console.log('é…ç½®æ— æ•ˆï¼šæ²¡æœ‰å¯ç”¨çš„å¼€å…³æˆ–éç©ºå€¼');
        return false;
    }

    // å¤„ç†ç«¯å£æ¨¡å¼å˜åŒ–
    function handlePortModeChange(portMode) {
        console.log('ç«¯å£æ¨¡å¼å˜åŒ–:', portMode);

        // è·å–ç«¯å£æ¨¡å¼ç›¸å…³å­—æ®µå®¹å™¨
        const portModeFields = document.querySelector('.port-mode-fields');
        const trunkOnlyFields = document.querySelectorAll('.trunk-only-field');

        if (portMode && portMode !== '') {
            // æ˜¾ç¤ºç«¯å£æ¨¡å¼ç›¸å…³å­—æ®µ
            if (portModeFields) {
                portModeFields.style.display = 'block';
                portModeFields.classList.add('show');
            }

            // æ ¹æ®æ¨¡å¼æ˜¾ç¤º/éšè—trunkä¸“ç”¨å­—æ®µ
            trunkOnlyFields.forEach(field => {
                if (portMode === 'trunk') {
                    field.style.display = 'block';
                } else {
                    field.style.display = 'none';
                }
            });

            // æ›´æ–°PVIDå­—æ®µæ ‡ç­¾
            updateFieldLabels();

        } else {
            // éšè—ç«¯å£æ¨¡å¼ç›¸å…³å­—æ®µ
            if (portModeFields) {
                portModeFields.style.display = 'none';
                portModeFields.classList.remove('show');
            }

            // éšè—æ‰€æœ‰trunkä¸“ç”¨å­—æ®µ
            trunkOnlyFields.forEach(field => {
                field.style.display = 'none';
            });
        }
    }

    // ç”Ÿæˆé»˜è®¤è¡¨å•
    function generateDefaultForm(moduleId) {
        return `
            <div class="mb-3">
                <label class="form-label">é…ç½®åç§° <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="config_name" placeholder="è¯·è¾“å…¥é…ç½®åç§°" required>
            </div>
            <div class="mb-3">
                <label class="form-label">æè¿°ä¿¡æ¯</label>
                <input type="text" class="form-control" name="description" placeholder="è¯·è¾“å…¥æè¿°ä¿¡æ¯">
            </div>
        `;
    }

    // åˆ é™¤äº†generatePreviewå‡½æ•°ï¼Œç›´æ¥åœ¨generateFinalConfigä¸­ç”Ÿæˆé…ç½®

    // æ”¶é›†è¡¨å•æ•°æ®ï¼ˆåˆ é™¤é‡å¤å‡½æ•°ï¼Œä½¿ç”¨ä¸‹é¢çš„å¢å¼ºç‰ˆï¼‰

    // è°ƒç”¨åç«¯APIç”Ÿæˆé…ç½®
    async function generateConfigFromAPI(vendor, configType, parameters) {
        console.log('è°ƒç”¨APIç”Ÿæˆé…ç½®:', { vendor, configType, parameters });

        const response = await fetch('/api/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                vendor: vendor,
                config_type: configType,
                parameters: parameters
            })
        });

        const data = await response.json();
        console.log('APIå“åº”:', data);

        if (data.success) {
            const commands = data.commands || [];
            if (commands.length === 0) {
                throw new Error('ç”Ÿæˆçš„é…ç½®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥å‚æ•°è®¾ç½®ã€‚ç¡®ä¿è‡³å°‘å¯ç”¨ä¸€ä¸ªé…ç½®é€‰é¡¹ã€‚');
            }
            return commands.join('\n');
        } else {
            throw new Error(data.error || 'é…ç½®ç”Ÿæˆå¤±è´¥');
        }
    }

    // ç”Ÿæˆæœ€ç»ˆé…ç½®
    async function generateFinalConfig() {
        console.log('ğŸš€ å¼€å§‹ç”Ÿæˆæœ€ç»ˆé…ç½®');
        console.log('å½“å‰æ­¥éª¤:', currentStep);
        console.log('é€‰ä¸­çš„æ¨¡å—:', Array.from(selectedModules));
        console.log('å½“å‰å‚å•†:', currentVendor);

        const container = document.getElementById('finalContent');
        let html = '';
        let hasValidConfig = false;

        // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ¨¡å—
        if (selectedModules.size === 0) {
            console.log('âŒ æ²¡æœ‰é€‰ä¸­ä»»ä½•æ¨¡å—');
            container.innerHTML = '<div class="text-danger">æ²¡æœ‰é€‰ä¸­ä»»ä½•é…ç½®æ¨¡å—</div>';
            return;
        }

        try {
            for (const moduleId of selectedModules) {
                console.log(`\nğŸ“‹ å¤„ç†æ¨¡å—: ${moduleId}`);

                // æ£€æŸ¥è¡¨å•åŒºåŸŸæ˜¯å¦å­˜åœ¨ï¼ˆåªæŸ¥æ‰¾é…ç½®è¡¨å•ï¼Œä¸æŸ¥æ‰¾æ¨¡å—é€‰æ‹©å¡ç‰‡ï¼‰
                const formSection = document.querySelector(`.config-section[data-module="${moduleId}"]`);
                console.log('è¡¨å•åŒºåŸŸ:', formSection);

                // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åœ¨configFormså®¹å™¨ä¸­æŸ¥æ‰¾
                if (!formSection) {
                    const configFormsContainer = document.getElementById('configForms');
                    const alternativeFormSection = configFormsContainer ?
                        configFormsContainer.querySelector(`[data-module="${moduleId}"]`) : null;
                    console.log('å¤‡ç”¨æŸ¥æ‰¾ç»“æœ:', alternativeFormSection);
                }

                if (!formSection) {
                    console.log(`âŒ æ‰¾ä¸åˆ°æ¨¡å— ${moduleId} çš„è¡¨å•åŒºåŸŸ`);
                    html += `<div class="config-module-section">
                        <h5><i class="fas fa-exclamation-triangle me-2 text-danger"></i>${getModuleName(moduleId)}</h5>
                        <div class="text-danger">æ‰¾ä¸åˆ°è¯¥æ¨¡å—çš„è¡¨å•åŒºåŸŸï¼Œå¯èƒ½è¡¨å•ç”Ÿæˆå¤±è´¥</div>
                    </div>`;
                    continue;
                }

                const formData = collectFormData(moduleId);
                console.log(`æ”¶é›†åˆ°çš„è¡¨å•æ•°æ® (${moduleId}):`, formData);

                // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„é…ç½®æ•°æ®
                const hasEnabledOptions = checkValidConfiguration(formData);

                if (!hasEnabledOptions) {
                    html += `<div class="config-module-section">
                        <h5><i class="fas fa-exclamation-triangle me-2 text-warning"></i>${getModuleName(moduleId)}</h5>
                        <div class="text-warning">
                            <p>è¯¥æ¨¡å—æ²¡æœ‰å¯ç”¨ä»»ä½•é…ç½®é€‰é¡¹ï¼Œè¯·æ£€æŸ¥å‚æ•°è®¾ç½®ã€‚</p>
                            <p>å»ºè®®ï¼šè‡³å°‘å¯ç”¨ä¸€ä¸ªé…ç½®å¼€å…³ï¼ˆå¦‚"æ˜¯å¦åˆ›å»ºVLAN"ã€"æ˜¯å¦é…ç½®æ¥å£"ç­‰ï¼‰ã€‚</p>
                            <p>è°ƒè¯•ä¿¡æ¯ï¼šæ”¶é›†åˆ°çš„æ•°æ® = ${JSON.stringify(formData)}</p>
                        </div>
                    </div>`;
                    continue;
                }

                try {
                    const config = await generateConfigFromAPI(currentVendor, moduleId, formData);
                    html += `<div class="config-module-section">
                        <h5><i class="fas fa-code me-2"></i>${getModuleName(moduleId)}</h5>
                        <div class="config-commands">
                            ${config.split('\n').map(line => `<div class="command-line">${line}</div>`).join('')}
                        </div>
                    </div>`;
                    hasValidConfig = true;
                } catch (moduleError) {
                    console.error(`æ¨¡å— ${moduleId} é…ç½®ç”Ÿæˆå¤±è´¥:`, moduleError);
                    html += `<div class="config-module-section">
                        <h5><i class="fas fa-exclamation-triangle me-2 text-danger"></i>${getModuleName(moduleId)}</h5>
                        <div class="text-danger">
                            <p>é…ç½®ç”Ÿæˆå¤±è´¥ï¼š${moduleError.message}</p>
                            <p>è¯·æ£€æŸ¥å‚æ•°è®¾ç½®ï¼Œç¡®ä¿å¿…è¦çš„é…ç½®é¡¹å·²æ­£ç¡®å¡«å†™ã€‚</p>
                        </div>
                    </div>`;
                }
            }

            if (!hasValidConfig && html === '') {
                html = `<div class="text-warning">
                    <h5><i class="fas fa-info-circle me-2"></i>é…ç½®æç¤º</h5>
                    <p>æ²¡æœ‰ç”Ÿæˆä»»ä½•é…ç½®ï¼Œå¯èƒ½çš„åŸå› ï¼š</p>
                    <ul>
                        <li>æ‰€æœ‰é…ç½®å¼€å…³éƒ½å¤„äºå…³é—­çŠ¶æ€</li>
                        <li>ç¼ºå°‘å¿…è¦çš„å‚æ•°è®¾ç½®</li>
                        <li>å‚æ•°æ ¼å¼ä¸æ­£ç¡®</li>
                    </ul>
                    <p>è¯·è¿”å›ä¸Šä¸€æ­¥æ£€æŸ¥é…ç½®å‚æ•°ã€‚</p>
                </div>`;
            }

        } catch (error) {
            console.error('ç”Ÿæˆé…ç½®å¤±è´¥:', error);
            html = `<div class="text-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>é…ç½®ç”Ÿæˆå¤±è´¥</h5>
                <p>é”™è¯¯ä¿¡æ¯ï¼š${error.message}</p>
                <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œè¾“å…¥å‚æ•°ï¼Œç„¶åé‡è¯•ã€‚</p>
            </div>`;
        }

        container.innerHTML = html;
    }

    // è¾…åŠ©å‡½æ•° - åŒ¹é…åç«¯é…ç½®ç±»å‹
    function getModuleName(moduleId) {
        const names = {
            'vlan_complete_config': 'VLANä¸€ä½“åŒ–é…ç½®',
            'port_aggregation': 'ç«¯å£èšåˆé…ç½®',
            'stp_config': 'STPç”Ÿæˆæ ‘åè®®',
            'interface_ip': 'æ¥å£IPé…ç½®',
            'static_route': 'é™æ€è·¯ç”±é…ç½®',
            'ospf_config': 'OSPFåŠ¨æ€è·¯ç”±',
            'dhcp_service': 'DHCPæœåŠ¡é…ç½®',
            'vrrp_config': 'VRRPç½‘å…³å†—ä½™é…ç½®'
        };
        return names[moduleId] || moduleId;
    }

    function generateModuleConfig(moduleId) {
        const configs = {
            'vlan_complete_config': 'vlan 100\nname VLAN_100\ninterface GigabitEthernet0/0/1\nport link-type access\nport default vlan 100',
            'port_aggregation': 'interface Eth-Trunk1\ntrunkport GigabitEthernet0/0/1 to 0/0/2\nmode lacp',
            'stp_config': 'stp enable\nstp mode rstp\nstp priority 4096',
            'interface_ip': 'interface Vlanif100\nip address 192.168.1.1 255.255.255.0\ndescription Management_VLAN',
            'static_route': 'ip route-static 0.0.0.0 0.0.0.0 192.168.1.254',
            'ospf_config': 'ospf 1\narea 0.0.0.0\nnetwork 192.168.1.0 0.0.0.255',
            'dhcp_service': 'dhcp enable\nip pool DHCP_POOL\nnetwork 192.168.1.0 mask 255.255.255.0\ngateway-list 192.168.1.1',
            'vrrp_config': 'interface Vlanif100\nvrrp vrid 1 virtual-ip 192.168.1.254\nvrrp vrid 1 priority 120'
        };
        return configs[moduleId] || `# ${moduleId} é…ç½®`;
    }

    // åˆ é™¤äº†åˆ·æ–°é¢„è§ˆåŠŸèƒ½

    // æå–å¯æ‰§è¡Œçš„é…ç½®å‘½ä»¤
    function extractExecutableConfig() {
        const container = document.getElementById('finalContent');
        const configSections = container.querySelectorAll('.config-module-section');

        let executableConfig = '';
        const timestamp = new Date().toLocaleString('zh-CN');

        // æ·»åŠ é…ç½®æ–‡ä»¶å¤´éƒ¨æ³¨é‡Š
        executableConfig += `!\n`;
        executableConfig += `! ${currentVendor.toUpperCase()} äº¤æ¢æœºé…ç½®æ–‡ä»¶\n`;
        executableConfig += `! ç”Ÿæˆæ—¶é—´: ${timestamp}\n`;
        executableConfig += `! ç”Ÿæˆå·¥å…·: äº¤æ¢æœºé…ç½®ç”Ÿæˆå™¨\n`;
        executableConfig += `!\n`;
        executableConfig += `! æ³¨æ„ï¼šè¯·æ ¹æ®å®é™…ç½‘ç»œç¯å¢ƒè°ƒæ•´å‚æ•°\n`;
        executableConfig += `!\n\n`;

        configSections.forEach(section => {
            const title = section.querySelector('h5');
            const commandsContainer = section.querySelector('.config-commands');

            if (title && commandsContainer) {
                const moduleName = title.textContent.replace(/^\s*[\w\s]*\s+/, '').trim();

                // æ·»åŠ æ¨¡å—æ³¨é‡Š
                executableConfig += `!\n`;
                executableConfig += `! ========== ${moduleName} ==========\n`;
                executableConfig += `!\n`;

                // æå–å‘½ä»¤è¡Œ
                const commandLines = commandsContainer.querySelectorAll('.command-line');
                commandLines.forEach(line => {
                    const command = line.textContent.trim();
                    if (command && command !== '') {
                        executableConfig += command + '\n';
                    }
                });

                executableConfig += '\n';
            }
        });

        // æ·»åŠ é…ç½®æ–‡ä»¶å°¾éƒ¨
        executableConfig += `!\n`;
        executableConfig += `! é…ç½®ç»“æŸ\n`;
        executableConfig += `!\n`;

        return executableConfig;
    }

    // å¤åˆ¶é…ç½®
    function copyConfig() {
        const executableConfig = extractExecutableConfig();

        if (!executableConfig || executableConfig.trim() === '') {
            alert('æ²¡æœ‰å¯å¤åˆ¶çš„é…ç½®å†…å®¹');
            return;
        }

        navigator.clipboard.writeText(executableConfig).then(() => {
            // æ˜¾ç¤ºæ›´å‹å¥½çš„æç¤º
            const commandCount = (executableConfig.match(/\n/g) || []).length;
            alert(`é…ç½®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nåŒ…å« ${commandCount} è¡Œé…ç½®å‘½ä»¤\nå¯ç›´æ¥ç²˜è´´åˆ° ${currentVendor.toUpperCase()} è®¾å¤‡ä¸­æ‰§è¡Œ`);
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©é…ç½®å†…å®¹è¿›è¡Œå¤åˆ¶');
        });
    }

    // ä¸‹è½½é…ç½®
    function downloadConfig() {
        const executableConfig = extractExecutableConfig();

        if (!executableConfig || executableConfig.trim() === '') {
            alert('æ²¡æœ‰å¯ä¸‹è½½çš„é…ç½®å†…å®¹');
            return;
        }

        // ç”Ÿæˆæ–‡ä»¶å
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
        const filename = `${currentVendor}_config_${timestamp}.txt`;

        // åˆ›å»ºä¸‹è½½
        const blob = new Blob([executableConfig], {
            type: 'text/plain;charset=utf-8'
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // æ˜¾ç¤ºä¸‹è½½æç¤º
        const commandCount = (executableConfig.match(/\n/g) || []).length;
        alert(`é…ç½®æ–‡ä»¶å·²ä¸‹è½½ï¼\n\næ–‡ä»¶å: ${filename}\nåŒ…å« ${commandCount} è¡Œé…ç½®å‘½ä»¤\nå¯ç›´æ¥å¯¼å…¥åˆ° ${currentVendor.toUpperCase()} è®¾å¤‡ä¸­`);
    }

    // å¼€å…³æ§åˆ¶å¤„ç†å‡½æ•°
    function handleToggleChange(paramName, isChecked) {
        // æ›´æ–°å¼€å…³æ ‡ç­¾
        const toggle = document.querySelector(`input[name="${paramName}"]`);
        if (toggle) {
            const label = toggle.closest('.d-flex').querySelector('.toggle-label');
            if (label) {
                label.textContent = isChecked ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
            }
        }

        // å¤„ç†æ¡ä»¶å­—æ®µæ˜¾ç¤º/éšè—
        const conditionalFields = document.querySelectorAll(`[data-depends-on="${paramName}"]`);
        conditionalFields.forEach(field => {
            if (isChecked) {
                field.classList.add('show');
            } else {
                field.classList.remove('show');
                // æ¸…ç©ºæ¡ä»¶å­—æ®µçš„å€¼
                const inputs = field.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
        });
    }

    // ä¸‹æ‹‰é€‰æ‹©å˜åŒ–å¤„ç†å‡½æ•°
    function handleSelectChange(paramName, selectedValue) {
        console.log(`ä¸‹æ‹‰é€‰æ‹©å˜åŒ–: ${paramName} = ${selectedValue}`);

        // å¤„ç†åŸºäºé€‰æ‹©å€¼çš„æ¡ä»¶å­—æ®µæ˜¾ç¤º/éšè—
        const conditionalFields = document.querySelectorAll(`[data-depends-on="${paramName}"]`);
        conditionalFields.forEach(field => {
            const dependsValue = field.getAttribute('data-depends-value');

            if (dependsValue) {
                // å¦‚æœå­—æ®µæœ‰ç‰¹å®šçš„ä¾èµ–å€¼ï¼Œåªæœ‰å½“é€‰æ‹©å€¼åŒ¹é…æ—¶æ‰æ˜¾ç¤º
                if (selectedValue === dependsValue) {
                    field.classList.add('show');
                } else {
                    field.classList.remove('show');
                    // æ¸…ç©ºæ¡ä»¶å­—æ®µçš„å€¼
                    const inputs = field.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    });
                }
            } else {
                // å¦‚æœå­—æ®µæ²¡æœ‰ç‰¹å®šçš„ä¾èµ–å€¼ï¼Œåªè¦æœ‰é€‰æ‹©å°±æ˜¾ç¤º
                if (selectedValue && selectedValue.trim() !== '') {
                    field.classList.add('show');
                } else {
                    field.classList.remove('show');
                    // æ¸…ç©ºæ¡ä»¶å­—æ®µçš„å€¼
                    const inputs = field.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        if (input.type === 'checkbox') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    });
                }
            }
        });
    }

    // ç”Ÿæˆå®Œæ•´çš„æ¥å£åç§° - ä¸ºæ¯ä¸ªæ¥å£å·ç éƒ½æ·»åŠ å‰ç¼€
    function generateFullInterfaceNames(prefix, numbers) {
        console.log(`ç”Ÿæˆå®Œæ•´æ¥å£åç§°: å‰ç¼€=${prefix}, å·ç =${numbers}`);

        if (!numbers || !numbers.trim()) {
            return '';
        }

        // æŒ‰é€—å·åˆ†å‰²æ¥å£å·ç 
        const numberParts = numbers.split(',').map(part => part.trim()).filter(part => part);
        console.log('åˆ†å‰²åçš„å·ç éƒ¨åˆ†:', numberParts);

        // ä¸ºæ¯ä¸ªå·ç éƒ¨åˆ†æ·»åŠ å‰ç¼€
        const fullInterfaces = numberParts.map(numberPart => {
            const fullInterface = `${prefix}${numberPart}`;
            console.log(`  ${numberPart} -> ${fullInterface}`);
            return fullInterface;
        });

        const result = fullInterfaces.join(',');
        console.log('æœ€ç»ˆæ¥å£åç§°:', result);
        return result;
    }

    // æ›´æ–°ç«¯å£ç»„åˆï¼ˆåˆ é™¤äº†é¢„è§ˆåŠŸèƒ½ï¼‰
    function updatePortCombination(paramName) {
        const portGroup = document.querySelector(`[data-param="${paramName}"]`);
        if (!portGroup) return;

        const prefixSelect = portGroup.querySelector('.port-prefix-select');
        const numberInput = portGroup.querySelector('.port-number-input');
        const hiddenInput = portGroup.querySelector(`input[name="${paramName}"]`);

        const prefix = prefixSelect.value;
        const numbers = numberInput.value.trim();

        if (prefix && numbers) {
            // ç”Ÿæˆå®Œæ•´çš„æ¥å£åç§° - ä¸ºæ¯ä¸ªæ¥å£å·ç éƒ½æ·»åŠ å‰ç¼€
            const fullInterface = generateFullInterfaceNames(prefix, numbers);
            hiddenInput.value = fullInterface;
            console.log(`æ¥å£ç»„åˆæ›´æ–°: ${paramName} = ${fullInterface}`);
        } else {
            hiddenInput.value = '';
            console.log(`æ¥å£ç»„åˆæ¸…ç©º: ${paramName}`);
        }
    }

    // åˆ é™¤äº†ç«¯å£æ ¼å¼éªŒè¯å‡½æ•°

    // æ”¶é›†è¡¨å•æ•°æ® - å¢å¼ºç‰ˆï¼Œæ”¯æŒç«¯å£ç»„åˆå’Œå¼€å…³çŠ¶æ€
    function collectFormData(moduleId) {
        console.log(`å¼€å§‹æ”¶é›†è¡¨å•æ•°æ®ï¼Œæ¨¡å—ID: ${moduleId}`);

        // ä¿®å¤ï¼šåªé€‰æ‹©é…ç½®è¡¨å•åŒºåŸŸï¼Œä¸é€‰æ‹©æ¨¡å—é€‰æ‹©å¡ç‰‡
        const formSection = document.querySelector(`.config-section[data-module="${moduleId}"]`);
        console.log('æ‰¾åˆ°çš„è¡¨å•åŒºåŸŸ:', formSection);

        // å¦‚æœæ²¡æ‰¾åˆ°é…ç½®è¡¨å•ï¼Œå°è¯•åœ¨configFormså®¹å™¨ä¸­æŸ¥æ‰¾
        if (!formSection) {
            const configFormsContainer = document.getElementById('configForms');
            const alternativeFormSection = configFormsContainer ?
                configFormsContainer.querySelector(`[data-module="${moduleId}"]`) : null;
            console.log('å¤‡ç”¨æŸ¥æ‰¾ç»“æœ:', alternativeFormSection);

            if (alternativeFormSection) {
                return collectFormDataFromElement(moduleId, alternativeFormSection);
            }
        }

        return collectFormDataFromElement(moduleId, formSection);
    }

    // ä»æŒ‡å®šå…ƒç´ æ”¶é›†è¡¨å•æ•°æ®
    function collectFormDataFromElement(moduleId, formSection) {
        if (!formSection) {
            console.log('âŒ æ²¡æœ‰æ‰¾åˆ°è¡¨å•åŒºåŸŸ');
            return {};
        }

        const formData = {};
        const inputs = formSection.querySelectorAll('input, select, textarea');
        console.log(`æ‰¾åˆ° ${inputs.length} ä¸ªè¾“å…¥æ§ä»¶`);

        inputs.forEach((input, index) => {
            console.log(`å¤„ç†ç¬¬ ${index + 1} ä¸ªæ§ä»¶:`, {
                type: input.type,
                name: input.name,
                value: input.value,
                checked: input.checked,
                classList: Array.from(input.classList)
            });

            // è·³è¿‡æ²¡æœ‰nameå±æ€§çš„æ§ä»¶
            if (!input.name) {
                console.log('  è·³è¿‡ï¼šæ²¡æœ‰nameå±æ€§');
                return;
            }

            // è·³è¿‡éšè—çš„ç«¯å£è¾“å…¥å­—æ®µçš„ç»„ä»¶
            if (input.classList.contains('port-prefix-select') ||
                input.classList.contains('port-number-input')) {
                console.log('  è·³è¿‡ï¼šç«¯å£è¾“å…¥ç»„ä»¶');
                return;
            }

            if (input.type === 'checkbox') {
                formData[input.name] = input.checked;
                console.log(`  âœ… æ”¶é›†å¤é€‰æ¡†: ${input.name} = ${input.checked}`);
            } else if (input.type === 'hidden' && input.name) {
                // å¤„ç†ç«¯å£ç»„åˆå­—æ®µ
                if (input.value && input.value.trim() !== '') {
                    formData[input.name] = input.value.trim();
                    console.log(`  âœ… æ”¶é›†éšè—å­—æ®µ: ${input.name} = ${input.value.trim()}`);
                } else {
                    console.log(`  è·³è¿‡éšè—å­—æ®µï¼ˆå€¼ä¸ºç©ºï¼‰: ${input.name}`);
                }
            } else if (input.value && input.value.trim() !== '') {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ•°ç»„å­—æ®µæ ¼å¼ (å¦‚: interface_entries[0].interface_type)
                const arrayMatch = input.name.match(/^(\w+)\[(\d+)\]\.(\w+)$/);
                if (arrayMatch) {
                    const [, arrayName, index, fieldName] = arrayMatch;
                    const arrayIndex = parseInt(index);

                    // åˆå§‹åŒ–æ•°ç»„
                    if (!formData[arrayName]) {
                        formData[arrayName] = [];
                    }

                    // åˆå§‹åŒ–æ•°ç»„é¡¹
                    if (!formData[arrayName][arrayIndex]) {
                        formData[arrayName][arrayIndex] = {};
                    }

                    formData[arrayName][arrayIndex][fieldName] = input.value.trim();
                    console.log(`  âœ… æ”¶é›†æ•°ç»„å­—æ®µ: ${arrayName}[${arrayIndex}].${fieldName} = ${input.value.trim()}`);
                } else {
                    formData[input.name] = input.value.trim();
                    console.log(`  âœ… æ”¶é›†æ™®é€šå­—æ®µ: ${input.name} = ${input.value.trim()}`);
                }
            } else {
                console.log(`  è·³è¿‡ï¼ˆå€¼ä¸ºç©ºï¼‰: ${input.name} = "${input.value}"`);
            }
        });

        // å¤„ç†æ•°ç»„å­—æ®µä¸­çš„å¤é€‰æ¡†
        inputs.forEach((input) => {
            if (input.type === 'checkbox' && input.name) {
                const arrayMatch = input.name.match(/^(\w+)\[(\d+)\]\.(\w+)$/);
                if (arrayMatch) {
                    const [, arrayName, index, fieldName] = arrayMatch;
                    const arrayIndex = parseInt(index);

                    // åˆå§‹åŒ–æ•°ç»„
                    if (!formData[arrayName]) {
                        formData[arrayName] = [];
                    }

                    // åˆå§‹åŒ–æ•°ç»„é¡¹
                    if (!formData[arrayName][arrayIndex]) {
                        formData[arrayName][arrayIndex] = {};
                    }

                    formData[arrayName][arrayIndex][fieldName] = input.checked;
                    console.log(`  âœ… æ”¶é›†æ•°ç»„å¤é€‰æ¡†: ${arrayName}[${arrayIndex}].${fieldName} = ${input.checked}`);
                }
            }
        });

        console.log('æœ€ç»ˆæ”¶é›†åˆ°çš„è¡¨å•æ•°æ®:', formData);
        return formData;
    }

    // ç”Ÿæˆæ•°ç»„ç±»å‹è¡¨å•å­—æ®µï¼ˆåŠ¨æ€è¡¨å•ï¼‰
    function generateArrayFormField(paramName, param) {
        const fieldId = `field_${paramName}`;
        let html = `<div class="mb-3 array-field" data-param="${paramName}">
            <label class="form-label">${param.description || paramName}</label>
            <div class="array-container border rounded p-3" id="${fieldId}_container">
                <div class="text-muted text-center py-3" id="${fieldId}_empty">
                    <i class="fas fa-plus-circle me-2"></i>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ é…ç½®æ¡ç›®
                </div>
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addArrayItem('${paramName}')">
                <i class="fas fa-plus me-1"></i>æ·»åŠ æ¡ç›®
            </button>
        </div>`;

        // å­˜å‚¨æ•°ç»„å­—æ®µçš„æ¨¡å¼ä¿¡æ¯
        if (!window.arrayFieldSchemas) {
            window.arrayFieldSchemas = {};
        }
        window.arrayFieldSchemas[paramName] = param.item_schema;

        return html;
    }

    // æ·»åŠ æ•°ç»„æ¡ç›®
    function addArrayItem(paramName) {
        const container = document.getElementById(`field_${paramName}_container`);
        const emptyMessage = document.getElementById(`field_${paramName}_empty`);
        const schema = window.arrayFieldSchemas[paramName];
        const itemIndex = container.querySelectorAll('.array-item').length;
        const itemId = `${paramName}_item_${itemIndex}`;

        // éšè—ç©ºçŠ¶æ€æç¤º
        if (emptyMessage) {
            emptyMessage.style.display = 'none';
        }

        let itemHtml = `<div class="array-item border rounded p-3 mb-2 bg-light" id="${itemId}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 text-primary">
                    <i class="fas fa-cog me-2"></i>æ¡ç›® ${itemIndex + 1}
                </h6>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeArrayItem('${itemId}', '${paramName}')">
                    <i class="fas fa-trash me-1"></i>åˆ é™¤
                </button>
            </div>
            <div class="row">`;

        // ç”Ÿæˆæ¯ä¸ªå­—æ®µ
        Object.entries(schema).forEach(([fieldName, fieldConfig]) => {
            const fullFieldName = `${paramName}[${itemIndex}].${fieldName}`;
            const fieldId = `field_${fullFieldName}`;

            itemHtml += `<div class="col-md-6 mb-3">
                <label for="${fieldId}" class="form-label">${fieldConfig.description || fieldName}
                    ${fieldConfig.required ? '<span class="text-danger">*</span>' : ''}
                </label>`;

            if (fieldConfig.type === 'boolean') {
                const checked = fieldConfig.default ? 'checked' : '';
                itemHtml += `<div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="${fieldId}" name="${fullFieldName}" ${checked}>
                    <label class="form-check-label" for="${fieldId}">
                        ${fieldConfig.default ? 'å¯ç”¨' : 'ç¦ç”¨'}
                    </label>
                </div>`;
            } else if (fieldConfig.options && fieldConfig.options.length > 0) {
                itemHtml += `<select class="form-control" id="${fieldId}" name="${fullFieldName}">
                    <option value="">è¯·é€‰æ‹©...</option>`;
                fieldConfig.options.forEach(option => {
                    const selected = fieldConfig.default === option ? 'selected' : '';
                    itemHtml += `<option value="${option}" ${selected}>${option}</option>`;
                });
                itemHtml += `</select>`;
            } else {
                const inputType = fieldConfig.type === 'integer' ? 'number' : 'text';
                const placeholder = fieldConfig.placeholder || '';
                const defaultValue = fieldConfig.default || '';
                const pattern = fieldConfig.pattern ? `pattern="${fieldConfig.pattern}"` : '';
                const min = fieldConfig.range ? `min="${fieldConfig.range[0]}"` : '';
                const max = fieldConfig.range ? `max="${fieldConfig.range[1]}"` : '';
                const maxLength = fieldConfig.max_length ? `maxlength="${fieldConfig.max_length}"` : '';
                const required = fieldConfig.required ? 'required' : '';

                itemHtml += `<input type="${inputType}" class="form-control" id="${fieldId}" name="${fullFieldName}"
                             placeholder="${placeholder}" value="${defaultValue}" ${pattern} ${min} ${max} ${maxLength} ${required}>`;
            }

            itemHtml += `</div>`;
        });

        itemHtml += `</div></div>`;

        container.insertAdjacentHTML('beforeend', itemHtml);
    }

    // åˆ é™¤æ•°ç»„æ¡ç›®
    function removeArrayItem(itemId, paramName) {
        const item = document.getElementById(itemId);
        const container = document.getElementById(`field_${paramName}_container`);
        const emptyMessage = document.getElementById(`field_${paramName}_empty`);

        if (item) {
            item.remove();

            // é‡æ–°ç¼–å·å‰©ä½™æ¡ç›®
            const remainingItems = container.querySelectorAll('.array-item');
            remainingItems.forEach((child, index) => {
                const title = child.querySelector('h6');
                if (title) {
                    title.innerHTML = `<i class="fas fa-cog me-2"></i>æ¡ç›® ${index + 1}`;
                }
            });

            // å¦‚æœæ²¡æœ‰æ¡ç›®äº†ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€æç¤º
            if (remainingItems.length === 0 && emptyMessage) {
                emptyMessage.style.display = 'block';
            }
        }
    }

    // æš´éœ²å…¨å±€å‡½æ•°
    window.nextStep = nextStep;
    window.previousStep = previousStep;
    window.copyConfig = copyConfig;
    window.downloadConfig = downloadConfig;
    window.handleToggleChange = handleToggleChange;
    window.handleSelectChange = handleSelectChange;
    window.updatePortCombination = updatePortCombination;
    window.handlePortModeChange = handlePortModeChange;
    window.updateFieldLabels = updateFieldLabels;
    window.addArrayItem = addArrayItem;
    window.removeArrayItem = removeArrayItem;
});
</script>
{% endblock %}
